# Scenario: M2 - 핵심 결제 흐름

---

**Work Package:** WP-M2
**총 Scenario 수:** 51개
**작성일:** 2026-01-14

---

## Phase 1: 카카오 로그인

### Scenario M2-001: 카카오 로그인 버튼 표시

- **Given:** 로그인 페이지가 로드됨
- **When:** 페이지를 확인함
- **Then:** 카카오 로그인 버튼이 이메일 로그인 옵션과 함께 표시됨
- **선행 Scenario:** M1-019

---

### Scenario M2-002: 카카오 로그인 성공 (신규 사용자)

- **Given:** 카카오 계정이 있고, 서비스에 처음 로그인함
- **When:** 카카오 로그인 버튼을 클릭하고 카카오 인증을 완료함
- **Then:** users 테이블에 새 사용자가 생성되고 홈 화면으로 이동함
- **선행 Scenario:** M1-011

---

### Scenario M2-003: 카카오 로그인 성공 (기존 사용자)

- **Given:** 카카오로 이전에 가입한 사용자가 있음
- **When:** 카카오 로그인 버튼을 클릭하고 인증함
- **Then:** 기존 계정으로 로그인되고 홈 화면으로 이동함
- **선행 Scenario:** M2-002

---

### Scenario M2-004: 카카오 로그인 취소

- **Given:** 카카오 로그인 화면이 열림
- **When:** 사용자가 로그인을 취소함
- **Then:** 로그인 페이지로 돌아가고 에러 없이 표시됨
- **선행 Scenario:** M1-019

---

### Scenario M2-005: 카카오 로그인 후 전화번호 입력 (선택)

- **Given:** 카카오 로그인이 완료됨, 전화번호가 없음
- **When:** 추가 정보 입력 화면에서 전화번호를 입력함
- **Then:** 전화번호가 users 테이블에 저장됨
- **선행 Scenario:** M2-002

---

### Scenario M2-006: 기존 이메일 로그인 유지 확인

- **Given:** 카카오 로그인이 구현됨
- **When:** 이메일/비밀번호로 로그인함
- **Then:** 정상적으로 로그인되어 기존 기능이 유지됨
- **선행 Scenario:** M1-019, M2-002

---

## Phase 2: 결제 연동 (포트원)

### Scenario M2-007: 모임 상세에서 신청하기 버튼 활성화

- **Given:** 모집중인 모임의 상세 페이지에 접속함
- **When:** 페이지를 확인함
- **Then:** "신청하기" 버튼이 활성화 상태로 표시됨
- **선행 Scenario:** M1-027

---

### Scenario M2-008: 정기모임 자격 체크 성공 (신규 회원)

- **Given:** 신규 회원(is_new_member=true)이 로그인됨
- **When:** 정기모임 신청을 시도함
- **Then:** 자격 체크 통과, 결제 진행 가능
- **선행 Scenario:** M2-007

---

### Scenario M2-009: 정기모임 자격 체크 성공 (6개월 이내 참여)

- **Given:** 마지막 정기모임 참여가 3개월 전인 회원
- **When:** 토론모임 신청을 시도함
- **Then:** 자격 체크 통과, 결제 진행 가능
- **선행 Scenario:** M2-007

---

### Scenario M2-010: 정기모임 자격 체크 실패 (6개월 초과)

- **Given:** 마지막 정기모임 참여가 7개월 전인 회원
- **When:** 토론모임 신청을 시도함
- **Then:** "정기모임 자격이 필요합니다" 안내와 정기모임 유도 팝업 표시
- **선행 Scenario:** M2-007

---

### Scenario M2-011: 정원 체크 성공 (자리 있음)

- **Given:** 정원 14명 중 10명이 신청 완료됨
- **When:** 신청하기 버튼을 클릭함
- **Then:** 정원 체크 통과, 결제 진행 가능
- **선행 Scenario:** M2-008

---

### Scenario M2-012: 정원 체크 실패 (마감)

- **Given:** 정원 14명이 모두 신청 완료됨
- **When:** 신청하기 버튼을 클릭함
- **Then:** "마감되었습니다. 대기 신청하시겠습니까?" 안내 표시
- **선행 Scenario:** M2-008

---

### Scenario M2-013: 결제 팝업 호출 성공

- **Given:** 정원 체크 통과, registrations에 pending 상태로 저장됨
- **When:** 결제 준비 API가 호출됨
- **Then:** 포트원 결제 팝업이 표시됨 (카카오페이/토스 선택 가능)
- **선행 Scenario:** M2-011

---

### Scenario M2-014: 카카오페이 결제 완료 성공

- **Given:** 포트원 결제 팝업에서 카카오페이를 선택함
- **When:** 카카오페이 인증을 완료함
- **Then:** 웹훅으로 결제 결과 전송, registrations 상태가 confirmed로 변경됨
- **선행 Scenario:** M2-013

---

### Scenario M2-015: 토스페이먼츠 결제 완료 성공

- **Given:** 포트원 결제 팝업에서 토스페이먼츠를 선택함
- **When:** 토스 인증을 완료함
- **Then:** 웹훅으로 결제 결과 전송, registrations 상태가 confirmed로 변경됨
- **선행 Scenario:** M2-013

---

### Scenario M2-016: 결제 완료 후 참가 인원 증가

- **Given:** 모임에 10명이 참가 중
- **When:** 새로운 결제가 완료됨
- **Then:** meetings.current_participants가 11로 증가함
- **선행 Scenario:** M2-014

---

### Scenario M2-017: 결제 완료 화면 표시

- **Given:** 결제가 성공적으로 완료됨
- **When:** 웹훅 처리가 완료됨
- **Then:** "신청이 완료되었습니다" 완료 화면이 표시됨
- **선행 Scenario:** M2-014

---

### Scenario M2-018: 결제 실패 처리 (사용자 취소)

- **Given:** 포트원 결제 팝업이 열림
- **When:** 사용자가 결제를 취소함
- **Then:** "결제가 취소되었습니다" 메시지 표시, pending registrations 정리됨
- **선행 Scenario:** M2-013

---

### Scenario M2-019: 결제 실패 처리 (잔액 부족)

- **Given:** 포트원 결제 팝업에서 결제 진행 중
- **When:** 잔액 부족으로 결제 실패함
- **Then:** "결제에 실패했습니다. 다시 시도해주세요" 메시지 표시
- **선행 Scenario:** M2-013

---

### Scenario M2-020: 동시성 제어 - 정원 초과 방지

- **Given:** 정원 14명 중 13명이 신청 완료됨
- **When:** 2명이 동시에 결제를 시도함
- **Then:** 1명만 결제 성공, 나머지 1명은 "마감되었습니다" 안내
- **선행 Scenario:** M2-011

---

### Scenario M2-021: 이미 신청한 모임 중복 신청 방지

- **Given:** 회원이 특정 모임에 이미 신청 완료함
- **When:** 동일 모임에 다시 신청을 시도함
- **Then:** "이미 신청한 모임입니다" 메시지 표시
- **선행 Scenario:** M2-014

---

## Phase 3: 취소/환불

### Scenario M2-022: 마이페이지에서 취소 버튼 표시

- **Given:** 회원이 신청 완료한 모임이 있음
- **When:** 마이페이지 신청 내역을 확인함
- **Then:** 해당 모임에 "취소하기" 버튼이 표시됨
- **선행 Scenario:** M2-014

---

### Scenario M2-023: 마음 돌리기 화면 표시

- **Given:** 취소하기 버튼을 클릭함
- **When:** 마음 돌리기 모달이 열림
- **Then:** 함께 신청한 회원, D-day, 환불 예정 금액이 표시됨
- **선행 Scenario:** M2-022

---

### Scenario M2-024: 정기모임 3일 전 취소 - 100% 환불

- **Given:** 정기모임까지 5일 남음, 결제 금액 10,000원
- **When:** 취소 사유 입력 후 취소를 확정함
- **Then:** 10,000원 전액 환불, registrations 상태 cancelled로 변경
- **선행 Scenario:** M2-023

---

### Scenario M2-025: 정기모임 2일 전 취소 - 50% 환불

- **Given:** 정기모임까지 2일 남음, 결제 금액 10,000원
- **When:** 취소 사유 입력 후 취소를 확정함
- **Then:** 5,000원 부분 환불, registrations.refund_amount에 기록됨
- **선행 Scenario:** M2-023

---

### Scenario M2-026: 정기모임 1일 전 취소 - 환불 불가

- **Given:** 정기모임까지 1일 남음
- **When:** 취소를 시도함
- **Then:** "환불 불가 기간입니다" 안내, 취소 버튼 비활성 또는 0% 환불 안내
- **선행 Scenario:** M2-023

---

### Scenario M2-027: 토론모임 2주 전 취소 - 100% 환불

- **Given:** 토론모임까지 20일 남음, 결제 금액 15,000원
- **When:** 취소 사유 입력 후 취소를 확정함
- **Then:** 15,000원 전액 환불
- **선행 Scenario:** M2-023

---

### Scenario M2-028: 토론모임 7일 전 취소 - 50% 환불

- **Given:** 토론모임까지 10일 남음, 결제 금액 15,000원
- **When:** 취소 사유 입력 후 취소를 확정함
- **Then:** 7,500원 부분 환불
- **선행 Scenario:** M2-023

---

### Scenario M2-029: 취소 사유 필수 입력 확인

- **Given:** 마음 돌리기 화면이 열림
- **When:** 취소 사유를 선택하지 않고 취소를 시도함
- **Then:** "취소 사유를 선택해주세요" 에러 메시지 표시
- **선행 Scenario:** M2-023

---

### Scenario M2-030: 취소 후 참가 인원 감소

- **Given:** 모임에 10명이 참가 중
- **When:** 1명이 취소함
- **Then:** meetings.current_participants가 9로 감소함
- **선행 Scenario:** M2-024

---

### Scenario M2-031: 포트원 환불 API 호출 성공

- **Given:** 취소가 확정되고 환불 금액이 계산됨
- **When:** 포트원 환불 API를 호출함
- **Then:** 환불이 처리되고 payment_status가 refunded/partial_refunded로 변경됨
- **선행 Scenario:** M2-024

---

### Scenario M2-032: 환불 API 실패 시 재시도 안내

- **Given:** 포트원 환불 API 호출 중
- **When:** 네트워크 오류로 실패함
- **Then:** "환불 처리 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요" 표시
- **선행 Scenario:** M2-031

---

## Phase 4: 대기 시스템

### Scenario M2-033: 마감 시 대기 신청 버튼 표시

- **Given:** 정원이 마감된 모임 상세 페이지
- **When:** 페이지를 확인함
- **Then:** "신청하기" 대신 "대기 신청" 버튼이 표시됨
- **선행 Scenario:** M2-012

---

### Scenario M2-034: 대기 등록 성공

- **Given:** 대기 신청 버튼이 표시됨
- **When:** 대기 신청 버튼을 클릭함
- **Then:** waitlists 테이블에 기록되고 대기 순번이 부여됨
- **선행 Scenario:** M2-033

---

### Scenario M2-035: 대기 순번 표시

- **Given:** 대기 등록이 완료됨, 3번째 대기자
- **When:** 모임 상세 또는 마이페이지를 확인함
- **Then:** "대기 3번째" 라고 표시됨
- **선행 Scenario:** M2-034

---

### Scenario M2-036: 대기 취소 성공

- **Given:** 대기 등록된 상태
- **When:** 대기 취소 버튼을 클릭함
- **Then:** waitlists에서 삭제되고 이후 대기자 순번이 조정됨
- **선행 Scenario:** M2-034

---

### Scenario M2-037: 취소 발생 시 대기자 확인 가능 (운영자)

- **Given:** 기존 신청자가 취소함, 대기자가 있음
- **When:** 운영자가 대기자 목록을 확인함
- **Then:** 1순위 대기자 정보가 표시됨 (M2에서는 수동 알림)
- **선행 Scenario:** M2-030, M2-034

---

### Scenario M2-038: 대기자 결제 진행 (자리 발생 후)

- **Given:** 대기자가 알림을 받음 (수동)
- **When:** 대기자가 결제를 진행함
- **Then:** 정상적으로 신청 확정, waitlists에서 삭제됨
- **선행 Scenario:** M2-037

---

### Scenario M2-039: 모임 상태 "대기가능" 표시

- **Given:** 정원이 마감되고 대기가 가능한 상태
- **When:** 모임 카드를 확인함
- **Then:** "마감" 대신 "대기가능" 파란색 뱃지가 표시됨
- **선행 Scenario:** M2-033

---

### Scenario M2-040: 이미 대기 등록한 모임 중복 대기 방지

- **Given:** 회원이 특정 모임에 이미 대기 등록함
- **When:** 동일 모임에 다시 대기 신청을 시도함
- **Then:** "이미 대기 중인 모임입니다" 메시지 표시
- **선행 Scenario:** M2-034

---

## Phase 5: 실시간 상태 & 마이페이지

### Scenario M2-041: 참가 인원 실시간 증가 확인

- **Given:** 모임 상세 페이지를 보고 있음, 현재 10명 참여
- **When:** 다른 사용자가 결제를 완료함
- **Then:** 새로고침 없이 "11명 참여"로 업데이트됨
- **선행 Scenario:** M2-016

---

### Scenario M2-042: 모임 상태 실시간 변경 (마감 임박 → 마감)

- **Given:** 홈 화면에서 "마감 임박" 모임을 보고 있음
- **When:** 마지막 자리가 결제됨
- **Then:** 새로고침 없이 "마감" 상태로 변경됨
- **선행 Scenario:** M2-041

---

### Scenario M2-043: 마이페이지 신청 내역 조회

- **Given:** 회원이 2개 모임에 신청 완료함
- **When:** 마이페이지 신청 내역에 접속함
- **Then:** 2개 모임이 신청 상태와 함께 목록으로 표시됨
- **선행 Scenario:** M2-014

---

### Scenario M2-044: 신청 상태별 구분 표시 (확정)

- **Given:** 결제 완료된 모임이 있음
- **When:** 마이페이지 신청 내역을 확인함
- **Then:** "[확정]" 뱃지가 표시됨
- **선행 Scenario:** M2-043

---

### Scenario M2-045: 신청 상태별 구분 표시 (대기)

- **Given:** 대기 등록된 모임이 있음
- **When:** 마이페이지 신청 내역을 확인함
- **Then:** "[대기 2번째]" 형태로 표시됨
- **선행 Scenario:** M2-034

---

### Scenario M2-046: 신청 상태별 구분 표시 (취소)

- **Given:** 취소한 모임이 있음
- **When:** 마이페이지 신청 내역을 확인함
- **Then:** "[취소됨]" 또는 취소 내역 탭에 표시됨
- **선행 Scenario:** M2-024

---

### Scenario M2-047: D-day 표시

- **Given:** 신청한 모임이 3일 후임
- **When:** 마이페이지 또는 홈 화면을 확인함
- **Then:** "D-3" 형태로 표시됨
- **선행 Scenario:** M2-043

---

### Scenario M2-048: 홈 화면 "내 신청 모임" 섹션 표시

- **Given:** 로그인되어 있고 신청한 모임이 있음
- **When:** 홈 화면에 접속함
- **Then:** 상단에 "내 신청 모임" 섹션이 표시됨
- **선행 Scenario:** M2-043

---

### Scenario M2-049: 홈 화면 "내 신청 모임" (신청 없음)

- **Given:** 로그인되어 있고 신청한 모임이 없음
- **When:** 홈 화면에 접속함
- **Then:** "내 신청 모임" 섹션이 표시되지 않거나 빈 상태 안내
- **선행 Scenario:** M1-019

---

### Scenario M2-050: Supabase Realtime 구독 연결

- **Given:** 모임 상세 페이지가 로드됨
- **When:** Realtime 채널에 구독함
- **Then:** meetings 테이블 UPDATE 이벤트를 수신할 수 있음
- **선행 Scenario:** M1-009

---

### Scenario M2-051: Realtime 연결 끊김 시 재연결

- **Given:** Realtime 구독이 활성화됨
- **When:** 네트워크가 일시적으로 끊김
- **Then:** 자동으로 재연결되고 최신 상태가 반영됨
- **선행 Scenario:** M2-050

---

## 검증 요약

| Phase | 성공 케이스 | 실패 케이스 | 합계 |
|-------|------------|------------|------|
| Phase 1 | 5 | 1 | 6 |
| Phase 2 | 11 | 4 | 15 |
| Phase 3 | 9 | 2 | 11 |
| Phase 4 | 7 | 1 | 8 |
| Phase 5 | 10 | 1 | 11 |
| **총계** | **42** | **9** | **51** |

> **Note:** 계좌이체 관련 시나리오는 [SC-M5-운영자도구.md](./SC-M5-운영자도구.md)에서 관리합니다.

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-14 | 1.0 | SC-M2 최초 작성 |
| 2026-01-20 | 1.1 | Phase 6 계좌이체 결제 시나리오 15개 추가 |
| 2026-01-20 | 1.2 | Phase 6 계좌이체 시나리오를 SC-M5로 이동 (운영자 확인 필수 기능이므로) |

