# Work Package: M14 - 결제 운영 (The Money Flow)

---

**문서 버전:** 1.0
**작성일:** 2026-01-28
**Milestone:** M14
**목표:** 매일 발생하는 입금 확인과 환불 처리를 효율적으로 수행
**기간:** 2주
**선행 조건:** M13 완료 (백오피스 기반 구축)
**우선순위:** 최우선 (운영 병목 해결)

---

## 1. Work Package 개요

M14는 운영자가 가장 빈번하게 수행하는 **결제 관련 업무**를 효율화합니다. 계좌이체 입금 확인, 환불 처리, 정산 현황 파악을 한 곳에서 빠르게 처리할 수 있게 합니다.

**핵심 목표:**
- 입금 대기 관리: 10건을 3분 이내 처리
- 환불 대기 관리: 계좌 정보 원클릭 복사
- 정산 현황: 월별 수입/환불 한눈에 파악
- 대시보드 위젯: 대기 건수 실시간 표시

```
[M13 완료: 백오피스 기반]
    |
    v
[Phase 14.1] 입금 대기 관리 + 대시보드 위젯
    |
    v
[Phase 14.2] 미입금 처리 + 기한 관리
    |
    v
[Phase 14.3] 환불 대기 관리
    |
    v
[Phase 14.4] 정산 현황
    |
    v
[M14 완료] -> M15 시작 가능
```

---

## 2. Phase 상세

### Phase 14.1: 입금 대기 관리 + 대시보드 위젯

**목표:** 계좌이체 입금 대기 건을 효율적으로 확인 처리

**예상 소요:** 4~5일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 14.1.1 | 입금 대기 목록 페이지 | `/app/admin/payments/pending/page.tsx` | 목록 렌더링 |
| 14.1.2 | 모임별 필터 구현 | 필터 UI + API | 모임 선택 시 해당 모임만 표시 |
| 14.1.3 | 입금자명 검색 구현 | 검색 UI + API | MMDD_이름 형식 검색 동작 |
| 14.1.4 | 단건 입금 확인 버튼 | UI + API | 클릭 시 confirmed 상태 변경 |
| 14.1.5 | 일괄 입금 확인 | 체크박스 + API | 다중 선택 후 일괄 처리 |
| 14.1.6 | 입금 확인 시 알림톡 발송 | 알림 연동 | TRANSFER_CONFIRMED 템플릿 사용 |
| 14.1.7 | 입금 대기 건수 API | `/api/admin/stats/pending-count/route.ts` | GET 요청 |
| 14.1.8 | 대시보드 입금 대기 위젯 | `PendingPaymentWidget.tsx` | N건 표시 + 클릭 시 목록 이동 |
| 14.1.9 | 빈 상태 UI | EmptyState 컴포넌트 | 대기 건 없을 때 안내 |

#### 입금 대기 목록 레이아웃

```
+-------------------------------------------------------------+
| 입금 대기 목록                          [모임 전체 v] [검색]  |
+-------------------------------------------------------------+
|                                                              |
| +----------------------------------------------------------+ |
| | [ ] 전체 선택                    선택 N건 [일괄 확인]     | |
| +----------------------------------------------------------+ |
|                                                              |
| +----------------------------------------------------------+ |
| | [ ] 홍길동 | 0120_홍길동 | 경주 정기 | 10,000콩 | D-16h   | |
| |                                              [입금 확인]  | |
| +----------------------------------------------------------+ |
|                                                              |
| +----------------------------------------------------------+ |
| | [ ] 김철수 | 0120_김철수 | 포항 토론 | 10,000콩 | D-20h   | |
| |                                              [입금 확인]  | |
| +----------------------------------------------------------+ |
|                                                              |
+-------------------------------------------------------------+
```

#### Scenario (검증 기준)

:red_circle: **SC-M14-001: 입금 대기 목록 조회**
- Given: 운영자가 admin 권한으로 로그인함
- When: /admin/payments/pending 페이지 접속
- Then: 현재 pending_transfer 상태인 모든 신청 건이 목록으로 표시됨

:red_circle: **SC-M14-002: 단건 입금 확인 처리**
- Given: 입금 대기 목록에 홍길동 건이 표시됨
- When: 해당 건의 [입금 확인] 버튼 클릭
- Then: 상태가 confirmed로 변경되고, 목록에서 사라지고, TRANSFER_CONFIRMED 알림톡 발송됨

:red_circle: **SC-M14-003: 일괄 입금 확인**
- Given: 입금 대기 목록에서 3건 선택함
- When: [일괄 확인] 버튼 클릭
- Then: 3건 모두 confirmed 상태로 변경, 각각 알림톡 발송됨

:yellow_circle: **SC-M14-004: 모임별 필터 동작**
- Given: 입금 대기 목록에 경주 정기 2건, 포항 토론 1건 있음
- When: 모임 필터에서 "경주 정기" 선택
- Then: 경주 정기 모임의 2건만 표시됨

:yellow_circle: **SC-M14-005: 입금자명 검색**
- Given: 입금 대기 목록에 여러 건 있음
- When: 검색창에 "0120_홍" 입력
- Then: 입금자명에 "0120_홍"이 포함된 건만 필터됨

:green_circle: **SC-M14-006: 대시보드 위젯 건수 표시**
- Given: 입금 대기 건이 5건 있음
- When: 대시보드 접속
- Then: "입금 대기 5건" 위젯이 표시됨

#### 사용자 가치
> "운영자가 입금 대기 목록에서 모임별/이름별로 빠르게 찾아서 10건을 3분 이내에 처리할 수 있다"

---

### Phase 14.2: 미입금 처리 + 기한 관리

**목표:** 24시간 경과 건 식별 및 수동 처리 기능

**예상 소요:** 3~4일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 14.2.1 | 24시간 경과 건 하이라이트 | UI 스타일링 | 경과 건은 빨간색 배경/텍스트 |
| 14.2.2 | 남은 시간 표시 | 유틸 함수 | D-16h, D-2h, 기한 초과 등 |
| 14.2.3 | 수동 취소 버튼 | UI + API | 운영자가 직접 취소 처리 |
| 14.2.4 | 취소 사유 입력 모달 | `CancelReasonModal.tsx` | 사유 필수 입력 |
| 14.2.5 | 기한 연장 기능 | UI + API | 12시간/24시간 연장 옵션 |
| 14.2.6 | 기한 연장 알림톡 | 알림 연동 | 연장 안내 발송 |
| 14.2.7 | 미입금 자동 취소 로그 | 로그 표시 | 자동 취소된 건 이력 조회 |

#### 미입금 건 표시 UI

```
+----------------------------------------------------------+
| [!] 박영희 | 0120_박영희 | 경주 정기 | 10,000콩 | 기한 초과 |
|     [기한 연장] [수동 취소]                                |
+----------------------------------------------------------+
```

#### Scenario (검증 기준)

:red_circle: **SC-M14-007: 24시간 경과 건 하이라이트**
- Given: 입금 대기 중 transfer_deadline이 지난 건 1건 있음
- When: 입금 대기 목록 조회
- Then: 해당 건이 빨간색 배경으로 하이라이트되고 "기한 초과" 표시됨

:red_circle: **SC-M14-008: 수동 취소 처리**
- Given: 기한 초과 건에서 [수동 취소] 버튼 클릭
- When: 취소 사유 "연락 두절" 입력 후 확인
- Then: 상태가 cancelled로 변경, 정원 복구, 사유가 기록됨

:yellow_circle: **SC-M14-009: 기한 연장**
- Given: 기한 임박 건에서 [기한 연장] 버튼 클릭
- When: "24시간 연장" 선택
- Then: transfer_deadline이 24시간 연장되고, 기한 연장 알림톡 발송됨

:yellow_circle: **SC-M14-010: 남은 시간 표시**
- Given: transfer_deadline이 현재 시각 + 16시간인 건
- When: 입금 대기 목록 조회
- Then: "D-16h"로 표시됨

#### 사용자 가치
> "운영자가 미입금 건을 빠르게 식별하고, 상황에 따라 연장하거나 취소할 수 있다"

---

### Phase 14.3: 환불 대기 관리

**목표:** 계좌이체 환불 건을 효율적으로 처리 (원클릭 복사)

**예상 소요:** 4~5일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 14.3.1 | 환불 대기 목록 페이지 | `/app/admin/payments/refund/page.tsx` | 목록 렌더링 |
| 14.3.2 | 환불 계좌 정보 표시 | UI 컴포넌트 | 은행/계좌/예금주 표시 |
| 14.3.3 | 계좌 정보 원클릭 복사 | `CopyButton.tsx` | 클릭 시 클립보드 복사 |
| 14.3.4 | 복사 형식 설정 | 옵션 | "계좌만" / "계좌+금액" 선택 |
| 14.3.5 | 단건 환불 완료 체크 | UI + API | 클릭 시 refunded 상태 변경 |
| 14.3.6 | 일괄 환불 완료 처리 | 체크박스 + API | 다중 선택 후 일괄 처리 |
| 14.3.7 | 환불 처리자 기록 | DB 저장 | refunded_by, refunded_at |
| 14.3.8 | 대시보드 환불 대기 위젯 | `PendingRefundWidget.tsx` | N건 표시 + 클릭 시 이동 |
| 14.3.9 | PG사 자동 환불 로그 | 로그 조회 | 성공/실패 내역 표시 |
| 14.3.10 | 환불 실패 건 재시도 안내 | UI 표시 | PG사 환불 실패 시 가이드 |

#### 환불 대기 목록 레이아웃

```
+-------------------------------------------------------------+
| 환불 대기 목록                                [일괄 완료]     |
+-------------------------------------------------------------+
|                                                              |
| +----------------------------------------------------------+ |
| | [ ] 김지독 | 경주 정기 | 10,000원 | 1/25                  | |
| |     신한은행 | 110-123-456789 | 김지독                    | |
| |     [계좌 복사] [계좌+금액 복사] [환불 완료]               | |
| +----------------------------------------------------------+ |
|                                                              |
| +----------------------------------------------------------+ |
| | [ ] 이독서 | 포항 토론 | 7,500원 | 1/24                   | |
| |     카카오뱅크 | 3333-12-3456789 | 이독서                  | |
| |     [계좌 복사] [계좌+금액 복사] [환불 완료]               | |
| +----------------------------------------------------------+ |
|                                                              |
+-------------------------------------------------------------+
```

#### 클립보드 복사 형식

```typescript
// 계좌만 복사
"신한은행 110-123-456789 김지독"

// 계좌+금액 복사
"신한은행 110-123-456789 김지독 10,000원"
```

#### Scenario (검증 기준)

:red_circle: **SC-M14-011: 환불 대기 목록 조회**
- Given: 계좌이체 취소 건 중 환불 미완료 건 3건 있음
- When: /admin/payments/refund 페이지 접속
- Then: 환불 대기 3건이 목록으로 표시되고, 각각 계좌 정보가 보임

:red_circle: **SC-M14-012: 계좌 정보 원클릭 복사**
- Given: 환불 대기 건에서 [계좌 복사] 버튼 클릭
- When: 클릭 완료
- Then: "신한은행 110-123-456789 김지독" 형식으로 클립보드에 복사됨

:red_circle: **SC-M14-013: 환불 완료 처리**
- Given: 환불 대기 건에서 [환불 완료] 버튼 클릭
- When: 확인 모달에서 "완료" 클릭
- Then: refund_status가 completed로 변경, refunded_by와 refunded_at 기록됨

:yellow_circle: **SC-M14-014: 일괄 환불 완료**
- Given: 환불 대기 목록에서 2건 선택함
- When: [일괄 완료] 버튼 클릭
- Then: 2건 모두 환불 완료 상태로 변경됨

:yellow_circle: **SC-M14-015: 계좌+금액 복사**
- Given: 환불 대기 건에서 [계좌+금액 복사] 버튼 클릭
- When: 클릭 완료
- Then: "신한은행 110-123-456789 김지독 10,000원" 형식으로 복사됨

:green_circle: **SC-M14-016: 대시보드 위젯 환불 건수**
- Given: 환불 대기 건이 2건 있음
- When: 대시보드 접속
- Then: "환불 대기 2건" 위젯이 표시됨

#### 사용자 가치
> "운영자가 환불 계좌 정보를 원클릭으로 복사해서 은행 앱에 바로 붙여넣고 환불 처리할 수 있다"

---

### Phase 14.4: 정산 현황

**목표:** 월별 수입/환불 내역을 한눈에 파악

**예상 소요:** 3~4일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 14.4.1 | 정산 현황 페이지 | `/app/admin/payments/settlement/page.tsx` | 기본 레이아웃 |
| 14.4.2 | 월 선택 필터 | 날짜 선택 UI | 월별 데이터 조회 |
| 14.4.3 | 예상 수입 계산 | 로직 구현 | 확정 건 총액 |
| 14.4.4 | 실제 수입 계산 | 로직 구현 | 입금 완료 건 총액 |
| 14.4.5 | 환불 금액 계산 | 로직 구현 | 환불 완료 건 총액 |
| 14.4.6 | 순수입 계산 | 로직 구현 | 실제 수입 - 환불 |
| 14.4.7 | 콩 -> 원화 환산 표시 | UI | 1콩 = 1원 환산 |
| 14.4.8 | 모임별 수입 내역 | 테이블 | 각 모임 수입 상세 |
| 14.4.9 | 환불 내역 테이블 | 테이블 | 건별 환불 금액/사유 |
| 14.4.10 | CSV 다운로드 | 기능 | 정산 데이터 내보내기 |

#### 정산 현황 레이아웃

```
+-------------------------------------------------------------+
| 정산 현황                                    [2026년 1월 v]   |
+-------------------------------------------------------------+
|                                                              |
| +-------------+ +-------------+ +-------------+ +-----------+|
| | 예상 수입   | | 실제 수입   | | 환불 금액   | | 순수입    ||
| | 500,000콩  | | 480,000콩  | | 30,000콩   | | 450,000콩 ||
| | (500,000원)| | (480,000원)| | (30,000원) | | (450,000원)||
| +-------------+ +-------------+ +-------------+ +-----------+|
|                                                              |
| +----------------------------------------------------------+ |
| | 모임별 수입 내역                                          | |
| +----------------------------------------------------------+ |
| | 모임명         | 참가자 | 예상 수입  | 실제 수입  | 환불  | |
| +----------------------------------------------------------+ |
| | 경주 정기 1월  | 14명   | 140,000콩 | 130,000콩 | 10,000||
| | 포항 토론 1월  | 12명   | 120,000콩 | 120,000콩 | 0     ||
| | ...            |        |           |           |       ||
| +----------------------------------------------------------+ |
|                                                              |
| +----------------------------------------------------------+ |
| | 환불 내역                                   [CSV 다운로드] | |
| +----------------------------------------------------------+ |
| | 회원명  | 모임명      | 금액     | 사유       | 일시     | |
| +----------------------------------------------------------+ |
| | 김지독  | 경주 정기   | 10,000콩 | 개인 사정  | 1/15    ||
| | 이독서  | 포항 토론   | 7,500콩  | 일정 변경  | 1/18    ||
| +----------------------------------------------------------+ |
|                                                              |
+-------------------------------------------------------------+
```

#### Scenario (검증 기준)

:red_circle: **SC-M14-017: 월별 정산 조회**
- Given: 2026년 1월에 결제 완료 50건, 환불 3건 있음
- When: 정산 현황 페이지에서 2026년 1월 선택
- Then: 예상 수입, 실제 수입, 환불 금액, 순수입이 정확히 계산되어 표시됨

:red_circle: **SC-M14-018: 콩-원화 환산 표시**
- Given: 순수입이 450,000콩인 월
- When: 정산 현황 조회
- Then: "450,000콩 (450,000원)" 형식으로 표시됨

:yellow_circle: **SC-M14-019: 모임별 수입 내역**
- Given: 해당 월에 3개 모임이 있음
- When: 정산 현황 조회
- Then: 각 모임별 참가자 수, 예상/실제 수입, 환불 금액이 테이블로 표시됨

:yellow_circle: **SC-M14-020: 환불 내역 상세**
- Given: 해당 월에 환불 3건 있음
- When: 환불 내역 섹션 조회
- Then: 각 환불 건의 회원명, 모임명, 금액, 사유, 일시가 표시됨

:green_circle: **SC-M14-021: CSV 다운로드**
- Given: 정산 현황 페이지에서 [CSV 다운로드] 클릭
- When: 다운로드 완료
- Then: 월별 정산 데이터가 CSV 파일로 저장됨

#### 사용자 가치
> "운영자가 월별 수입과 환불 현황을 한눈에 파악하고, 필요 시 데이터를 다운로드할 수 있다"

---

## 3. 기술 스택

| 영역 | 기술 | 용도 |
|------|------|------|
| 클립보드 | Navigator.clipboard API | 계좌 정보 복사 |
| 테이블 | @tanstack/react-table | 정렬/필터/페이지네이션 |
| 날짜 | date-fns | 남은 시간 계산, 월별 필터 |
| CSV | 자체 구현 | 정산 데이터 내보내기 |
| API | Next.js Route Handlers | 백엔드 로직 |
| DB | Supabase | registrations, refund_info 조회 |
| 알림 | 솔라피 | 입금 확인/기한 연장 알림톡 |

---

## 4. 파일 구조

```
/app/admin/payments
├── pending/
│   └── page.tsx              # 입금 대기 목록
├── refund/
│   └── page.tsx              # 환불 대기 목록
└── settlement/
    └── page.tsx              # 정산 현황

/components/admin/payments
├── PendingPaymentList.tsx    # 입금 대기 목록 컴포넌트
├── PendingPaymentItem.tsx    # 입금 대기 항목
├── RefundList.tsx            # 환불 대기 목록 컴포넌트
├── RefundItem.tsx            # 환불 대기 항목
├── CopyButton.tsx            # 클립보드 복사 버튼
├── CancelReasonModal.tsx     # 취소 사유 입력 모달
├── ExtendDeadlineModal.tsx   # 기한 연장 모달
├── SettlementSummary.tsx     # 정산 요약 카드
├── SettlementByMeeting.tsx   # 모임별 수입 테이블
└── RefundHistory.tsx         # 환불 내역 테이블

/components/admin/dashboard
├── PendingPaymentWidget.tsx  # 입금 대기 위젯
└── PendingRefundWidget.tsx   # 환불 대기 위젯

/app/api/admin/payments
├── pending/
│   └── route.ts              # GET: 입금 대기 목록
├── confirm/
│   └── route.ts              # POST: 입금 확인 처리
├── bulk-confirm/
│   └── route.ts              # POST: 일괄 입금 확인
├── cancel/
│   └── route.ts              # POST: 수동 취소
├── extend/
│   └── route.ts              # POST: 기한 연장
├── refund/
│   └── route.ts              # GET: 환불 대기 목록
├── refund-complete/
│   └── route.ts              # POST: 환불 완료 처리
├── settlement/
│   └── route.ts              # GET: 정산 현황
└── stats/
    └── pending-count/
        └── route.ts          # GET: 대기 건수

/lib/admin
├── payment-utils.ts          # 결제 관련 유틸
├── settlement-utils.ts       # 정산 계산 유틸
└── csv-export.ts             # CSV 내보내기
```

---

## 5. DB 스키마 변경

```sql
-- registrations 테이블에 환불 처리자 정보 추가 (이미 있는 경우 생략)
ALTER TABLE registrations ADD COLUMN IF NOT EXISTS refunded_by UUID REFERENCES users(id);
ALTER TABLE registrations ADD COLUMN IF NOT EXISTS refunded_at TIMESTAMPTZ;

-- 정산 관련 뷰 생성 (선택)
CREATE OR REPLACE VIEW monthly_settlement AS
SELECT
  DATE_TRUNC('month', r.created_at) as month,
  m.id as meeting_id,
  m.title as meeting_title,
  COUNT(*) FILTER (WHERE r.status = 'confirmed') as confirmed_count,
  SUM(r.payment_amount) FILTER (WHERE r.payment_status = 'paid') as total_paid,
  SUM(r.refund_amount) FILTER (WHERE r.refund_status = 'completed') as total_refunded
FROM registrations r
JOIN meetings m ON r.meeting_id = m.id
GROUP BY DATE_TRUNC('month', r.created_at), m.id, m.title;
```

---

## 6. 전체 완료 검증

### Phase 14.1 완료 조건
- [ ] 입금 대기 목록 렌더링
- [ ] 모임별 필터 동작
- [ ] 입금자명 검색 동작
- [ ] 단건 입금 확인 처리
- [ ] 일괄 입금 확인 처리
- [ ] 입금 확인 시 알림톡 발송
- [ ] 대시보드 위젯 건수 표시

### Phase 14.2 완료 조건
- [ ] 24시간 경과 건 하이라이트
- [ ] 남은 시간 D-Xh 표시
- [ ] 수동 취소 + 사유 입력
- [ ] 기한 연장 동작
- [ ] 기한 연장 알림톡 발송

### Phase 14.3 완료 조건
- [ ] 환불 대기 목록 렌더링
- [ ] 계좌 정보 원클릭 복사
- [ ] 계좌+금액 복사 옵션
- [ ] 단건/일괄 환불 완료 처리
- [ ] 처리자/처리일시 기록
- [ ] 대시보드 위젯 건수 표시

### Phase 14.4 완료 조건
- [ ] 월별 정산 조회
- [ ] 예상/실제/환불/순수입 계산
- [ ] 콩-원화 환산 표시
- [ ] 모임별 수입 내역 테이블
- [ ] 환불 내역 테이블
- [ ] CSV 다운로드

### 전체 M14 완료 조건
- [ ] 모든 Phase 완료
- [ ] 모든 Scenario 통과
- [ ] 입금 확인 10건을 3분 이내 처리 가능
- [ ] 환불 계좌 정보 원클릭 복사 동작
- [ ] TypeScript 에러 0개
- [ ] 빌드 성공
- [ ] main 머지 완료

---

## 7. 의존성 다이어그램

```
[M13 완료: 백오피스 기반]
├── Admin 인증/권한
├── 사이드바 레이아웃
└── app_settings 테이블
    |
    v
[Phase 14.1] 입금 대기 관리
├── 목록/필터/검색
├── 단건/일괄 확인
└── 대시보드 위젯
    |
    v
[Phase 14.2] 미입금 처리
├── 24시간 경과 하이라이트
├── 수동 취소
└── 기한 연장
    |
    v
[Phase 14.3] 환불 대기 관리
├── 환불 목록
├── 계좌 복사
└── 환불 완료 처리
    |
    v
[Phase 14.4] 정산 현황
├── 월별 정산
├── 수입/환불 계산
└── CSV 내보내기
    |
    v
[M14 완료] -> M15 시작 가능
```

---

## 8. 위험 관리

| 위험 | 영향 | 대응 방안 |
|------|------|----------|
| 클립보드 API 브라우저 호환 | 일부 브라우저에서 복사 실패 | execCommand fallback 구현 |
| 대량 일괄 처리 시 타임아웃 | API 응답 지연 | 배치 처리, 진행률 표시 |
| 알림톡 발송 실패 | 회원 미통보 | 재시도 로직, 실패 로그 표시 |
| 정산 쿼리 성능 | 데이터 증가 시 느려짐 | 인덱스 최적화, 뷰 캐싱 |
| 동시 입금 확인 충돌 | 중복 처리 | 낙관적 잠금, 이미 처리 건 알림 |

---

## 9. 성공 기준

| 지표 | 현재 | 목표 |
|------|------|------|
| 입금 확인 10건 처리 시간 | 10분+ | **3분 이내** |
| 환불 계좌 복사 단계 | 3단계 (보기>선택>복사) | **1클릭** |
| 정산 현황 파악 시간 | 스프레드시트 직접 계산 | **즉시** |
| 미입금 건 식별 | 수동 확인 | **자동 하이라이트** |

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-28 | 1.0 | 최초 작성 |
