# Work Package: M2 - 핵심 결제 흐름

---

**Milestone:** M2  
**목표:** "신청 → 결제 → 취소 → 환불" 전체 흐름 완성  
**기간:** 2~3주  
**선행 조건:** M1 완료  
**테스트:** Alpha 테스트 (운영자 + 친한 회원 3~5명)

---

## 1. Work Package 개요

M2는 **5개의 Phase**로 구성됩니다. 각 Phase가 끝나면 "동작하는" 소프트웨어 상태가 됩니다.

> **Note:** 계좌이체 결제는 운영자 확인이 필수이므로 **M5 운영자 도구**에서 구현합니다. [WP-M5-운영자도구.md](./WP-M5-운영자도구.md) 참조.

```
Phase 1: 카카오 로그인
    ↓ [동작 확인: 카카오로 로그인 가능]
Phase 2: 결제 연동 (포트원)
    ↓ [동작 확인: 모임 신청 + 결제 동작]
Phase 3: 취소/환불
    ↓ [동작 확인: 취소 시 자동 환불]
Phase 4: 대기 시스템
    ↓ [동작 확인: 정원 초과 시 대기 등록]
Phase 5: 실시간 상태 & 마이페이지
    ↓ [동작 확인: 참가 인원 실시간 반영, 신청 내역 확인]
```

---

## 2. Phase 상세

### Phase 1: 카카오 로그인

**목표:** 기존 이메일 로그인 외에 카카오 소셜 로그인 지원

**예상 소요:** 1일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.1 | 카카오 개발자 앱 등록 | 카카오 앱 키 | REST API 키 획득 |
| 1.2 | Supabase Auth 카카오 설정 | Provider 설정 | 카카오 OAuth 연동 |
| 1.3 | 로그인 페이지 카카오 버튼 | UI 컴포넌트 | 카카오 로그인 버튼 |
| 1.4 | OAuth 콜백 처리 | 콜백 페이지 | 로그인 후 리다이렉트 |
| 1.5 | 프로필 정보 저장 | users 테이블 업데이트 | 이름, 이메일 저장 |
| 1.6 | 전화번호 입력 (선택) | 추가 정보 입력 폼 | 알림톡 수신용 |

#### 완료 검증

- [ ] 카카오 로그인 버튼 클릭 → 카카오 로그인 화면
- [ ] 카카오 로그인 성공 → 홈 화면 이동
- [ ] users 테이블에 카카오 사용자 정보 저장
- [ ] 기존 이메일 로그인도 정상 동작 유지

#### 사용자 가치

> 🎯 **"회원이 카카오톡 계정으로 간편하게 로그인할 수 있다"**

---

### Phase 2: 결제 연동 (포트원)

**목표:** 모임 신청 시 카카오페이/토스페이먼츠로 결제 가능

**예상 소요:** 3~4일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 2.1 | 포트원 계정 생성 | 포트원 API 키 | 샌드박스 환경 |
| 2.2 | 포트원 SDK 설치 | 패키지 설치 | npm install |
| 2.3 | 결제 준비 API | `/app/api/payments/prepare/route.ts` | 결제 정보 생성 |
| 2.4 | 모임 상세 "신청하기" 버튼 | UI 컴포넌트 | 버튼 활성화 |
| 2.5 | 신청 전 자격 체크 | 로직 | 정기모임 6개월 규정 |
| 2.6 | 정원 체크 (동시성) | DB 트랜잭션 | 정원 초과 방지 |
| 2.7 | 결제 팝업 호출 | 포트원 SDK | 카카오페이/토스 선택 |
| 2.8 | 결제 완료 웹훅 | `/app/api/payments/webhook/route.ts` | 결제 상태 업데이트 |
| 2.9 | registrations 상태 업데이트 | DB 업데이트 | confirmed 상태 |
| 2.10 | 결제 완료 화면 | 완료 페이지 | 신청 완료 안내 |
| 2.11 | 결제 실패 처리 | 에러 처리 | 재시도 안내 |

#### 결제 흐름

```
사용자: "신청하기" 클릭
    ↓
서버: 자격 체크 (정기모임 6개월 규정)
    ↓
서버: 정원 체크 (동시성 제어)
    ↓
서버: registrations 생성 (status: pending)
    ↓
서버: 결제 준비 API 호출 → 결제 정보 반환
    ↓
클라이언트: 포트원 결제 팝업 호출
    ↓
사용자: 카카오페이/토스 결제 진행
    ↓
포트원 → 서버: 웹훅으로 결제 결과 전송
    ↓
서버: registrations 상태 업데이트 (confirmed)
    ↓
서버: meetings.current_participants +1
    ↓
클라이언트: 완료 화면 표시
```

#### 동시성 제어 (정원 초과 방지)

```sql
-- 신청 전 정원 체크 (트랜잭션 내에서)
BEGIN;

SELECT current_participants, capacity 
FROM meetings 
WHERE id = $1 
FOR UPDATE;

-- current_participants < capacity 확인
-- 조건 충족 시에만 registrations INSERT

UPDATE meetings 
SET current_participants = current_participants + 1 
WHERE id = $1;

COMMIT;
```

#### 완료 검증

- [ ] 모임 상세에서 "신청하기" 버튼 클릭 가능
- [ ] 카카오페이 또는 토스페이먼츠 결제 팝업 표시
- [ ] 결제 완료 후 신청 확정 (registrations 상태 변경)
- [ ] 결제 완료 후 참가 인원 +1 증가
- [ ] 동시에 여러 명이 결제해도 정원 초과 안 됨 (동시성 테스트)
- [ ] 결제 실패 시 적절한 에러 메시지

#### 사용자 가치

> 🎯 **"회원이 모임을 선택하고 즉시 결제하여 참여를 확정할 수 있다"**

---

### Phase 3: 취소/환불

**목표:** 회원이 직접 취소하면 환불 규정에 따라 자동 환불

**예상 소요:** 2~3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 3.1 | 환불 규정 계산 로직 | `/lib/refund.ts` | 모임 유형별 계산 |
| 3.2 | 취소 버튼 (마이페이지) | UI 컴포넌트 | 신청 내역에서 취소 |
| 3.3 | 마음 돌리기 화면 | 취소 확인 모달 | 취소 마찰 증가 |
| 3.4 | 취소 사유 입력 | 필수 입력 폼 | 드롭다운 + 기타 |
| 3.5 | 환불 금액 미리보기 | 환불 계산 표시 | 취소 전 확인 |
| 3.6 | 포트원 환불 API 연동 | `/app/api/payments/refund/route.ts` | 부분 환불 포함 |
| 3.7 | registrations 상태 업데이트 | DB 업데이트 | cancelled 상태 |
| 3.8 | 참가 인원 감소 | DB 업데이트 | current_participants -1 |
| 3.9 | 환불 불가 안내 | UI | 환불 불가 기간 안내 |

#### 환불 규정 로직

```typescript
// /lib/refund.ts
interface RefundRule {
  days_before: number;
  refund_percent: number;
}

function calculateRefund(
  meetingDate: Date,
  rules: RefundRule[],
  paymentAmount: number
): { refundAmount: number; refundPercent: number; isRefundable: boolean } {
  const now = new Date();
  const daysUntilMeeting = Math.ceil(
    (meetingDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)
  );
  
  // 규정 정렬 (days_before 내림차순)
  const sortedRules = [...rules].sort((a, b) => b.days_before - a.days_before);
  
  for (const rule of sortedRules) {
    if (daysUntilMeeting >= rule.days_before) {
      const refundAmount = Math.floor(paymentAmount * rule.refund_percent / 100);
      return {
        refundAmount,
        refundPercent: rule.refund_percent,
        isRefundable: rule.refund_percent > 0
      };
    }
  }
  
  return { refundAmount: 0, refundPercent: 0, isRefundable: false };
}
```

#### 마음 돌리기 화면 구성

```
┌─────────────────────────────────────┐
│         정말 취소하시겠어요?          │
├─────────────────────────────────────┤
│                                      │
│ 📅 경주 정기모임 (1월 20일)           │
│                                      │
│ 👥 함께 신청한 회원                   │
│    • 김독서, 박책방 외 3명            │
│                                      │
│ ⏰ 모임까지 D-3                       │
│                                      │
│ 💰 환불 예정 금액: 10,000콩 (100%)    │
│    (3일 전까지 전액 환불)             │
│                                      │
├─────────────────────────────────────┤
│ 취소 사유 (필수)                      │
│ ┌─────────────────────────────────┐ │
│ │ ▼ 일정이 변경되어서              │ │
│ └─────────────────────────────────┘ │
│                                      │
│ [계속 참여하기]  [취소하기]           │
└─────────────────────────────────────┘
```

#### 취소 사유 옵션

- 일정이 변경되어서
- 개인 사정으로
- 다른 모임에 참여해서
- 건강 문제로
- 기타 (직접 입력)

#### 완료 검증

- [ ] 마이페이지에서 신청한 모임 취소 가능
- [ ] 마음 돌리기 화면에 함께 신청한 회원, D-day 표시
- [ ] 취소 사유 필수 입력
- [ ] 환불 규정에 따라 정확한 금액 환불 (100%, 50%, 0%)
- [ ] 부분 환불(50%) 정상 처리
- [ ] 환불 불가 기간에는 취소 버튼 비활성 또는 안내
- [ ] 취소 후 참가 인원 -1 감소

#### 사용자 가치

> 🎯 **"회원이 직접 취소하면 운영자 개입 없이 자동으로 환불받을 수 있다"**

---

### Phase 4: 대기 시스템

**목표:** 정원 초과 시 대기 등록, 취소 발생 시 대기자 전환 가능

**예상 소요:** 1~2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 4.1 | waitlists 테이블 생성 | SQL 마이그레이션 | 테이블 생성 |
| 4.2 | 대기 등록 버튼 | UI 컴포넌트 | 정원 마감 시 표시 |
| 4.3 | 대기 등록 API | `/app/api/waitlists/route.ts` | POST 요청 |
| 4.4 | 대기 순번 표시 | UI | "대기 3번째" |
| 4.5 | 대기 취소 기능 | 취소 버튼 | 대기 목록에서 삭제 |
| 4.6 | 취소 발생 시 대기자 알림 | 트리거/로직 | 1순위 대기자 선택 |
| 4.7 | 대기자 신청 전환 | 결제 진행 | 대기 → 신청 |
| 4.8 | 모임 상태 "대기가능" | 상태 표시 | 마감 + 대기 가능 |

#### waitlists 테이블

```sql
CREATE TABLE waitlists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) NOT NULL,
  meeting_id UUID REFERENCES meetings(id) NOT NULL,
  position INTEGER NOT NULL, -- 대기 순번
  notified_at TIMESTAMP, -- 알림 발송 시각
  response_deadline TIMESTAMP, -- 응답 기한
  status VARCHAR(20) DEFAULT 'waiting', -- waiting, notified, converted, expired, cancelled
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, meeting_id)
);
```

#### 대기자 처리 흐름 (M3에서 자동화, M2에서는 수동)

```
취소 발생
    ↓
서버: 자리 발생 확인 (current_participants < capacity)
    ↓
서버: 1순위 대기자 조회 (position = 1)
    ↓
[M2] 운영자: 대기자에게 수동 연락
[M3] 서버: 대기자에게 알림톡 자동 발송
    ↓
대기자: 결제 진행 → 신청 확정
    ↓
서버: waitlists 삭제, registrations 생성
```

#### 완료 검증

- [ ] 정원 마감 시 "대기 신청" 버튼 표시
- [ ] 대기 등록 후 순번 표시 ("대기 3번째")
- [ ] 대기 취소 가능
- [ ] 취소 발생 시 대기자 목록에서 1순위 확인 가능 (운영자 화면)
- [ ] 대기자가 결제하면 정상적으로 신청 확정

#### 사용자 가치

> 🎯 **"정원이 마감되어도 대기 신청으로 기회를 얻을 수 있다"**

---

### Phase 5: 실시간 상태 & 마이페이지

**목표:** 참가 인원 실시간 반영, 마이페이지에서 신청 내역 확인

**예상 소요:** 1~2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 5.1 | Supabase Realtime 설정 | 구독 설정 | meetings 테이블 구독 |
| 5.2 | 참가 인원 실시간 업데이트 | UI 업데이트 | 새로고침 없이 반영 |
| 5.3 | 모임 상태 실시간 변경 | 상태 뱃지 | 마감 임박 → 마감 자동 전환 |
| 5.4 | 마이페이지 신청 내역 | `/app/mypage/registrations/page.tsx` | 내 신청 목록 |
| 5.5 | 신청 상태별 표시 | UI | 확정/대기/취소 구분 |
| 5.6 | D-day 표시 | UI | "D-3" 형태 |
| 5.7 | 내 신청 모임 홈 표시 | 홈 화면 섹션 | "내 신청 모임" |

#### Supabase Realtime 구현

```typescript
// 모임 참가 인원 실시간 구독
useEffect(() => {
  const subscription = supabase
    .channel('meetings')
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'meetings',
        filter: `id=eq.${meetingId}`
      },
      (payload) => {
        setMeeting(prev => ({
          ...prev,
          current_participants: payload.new.current_participants
        }));
      }
    )
    .subscribe();

  return () => {
    subscription.unsubscribe();
  };
}, [meetingId]);
```

#### 마이페이지 신청 내역 UI

```
┌─────────────────────────────────────┐
│ 📋 내 신청 모임                      │
├─────────────────────────────────────┤
│                                      │
│ ┌─────────────────────────────────┐ │
│ │ D-3  경주 정기모임               │ │
│ │ 📅 1월 20일 (토) 14:00          │ │
│ │ 📍 경주 황리단길 북카페          │ │
│ │ [확정]              [취소하기]  │ │
│ └─────────────────────────────────┘ │
│                                      │
│ ┌─────────────────────────────────┐ │
│ │ D-10 포항 토론모임               │ │
│ │ 📅 1월 27일 (토) 14:00          │ │
│ │ 📍 포항 카페                     │ │
│ │ [대기 2번째]        [취소하기]  │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

#### 완료 검증

- [ ] 다른 사람이 결제하면 참가 인원 실시간 증가 (새로고침 없이)
- [ ] 정원 도달 시 "마감" 상태로 자동 변경
- [ ] 마이페이지에서 내 신청 목록 확인
- [ ] 신청 상태(확정/대기/취소) 명확히 구분
- [ ] 홈 화면에 "내 신청 모임" 섹션 표시

#### 사용자 가치

> 🎯 **"참가 인원이 실시간으로 반영되고, 내 신청 내역을 쉽게 확인할 수 있다"**

---

## 3. M2 완료 검증 체크리스트

### 기능 검증

- [ ] 카카오 로그인 정상 동작
- [ ] 모임 신청 → 결제 완료까지 전체 흐름
- [ ] 결제 완료 후 참가 인원 실시간 증가
- [ ] 취소 시 환불 규정에 따라 정확한 환불
- [ ] 부분 환불(50%) 정상 처리
- [ ] 정원 초과 시 대기 등록 가능
- [ ] 마이페이지에서 신청 내역 확인

### 비즈니스 규칙 검증

- [ ] 정기모임 자격 체크 (6개월 규정)
- [ ] 동시 결제 시 정원 초과 방지
- [ ] 환불 규정 정확히 적용 (정기: 3일/2일, 토론: 2주/7일)

### 기술 검증

- [ ] 포트원 웹훅 정상 수신
- [ ] Supabase Realtime 동작
- [ ] 결제 실패 시 적절한 에러 처리

---

## 4. Alpha 테스트 계획

### 테스트 대상

- 운영자: 1명
- 친한 회원: 3~5명

### 테스트 시나리오

1. **정상 결제 흐름**
   - 모임 선택 → 신청 → 결제 → 완료

2. **취소/환불 흐름**
   - 3일 전 취소 → 100% 환불 확인
   - 2일 전 취소 → 50% 환불 확인

3. **대기 등록 흐름**
   - 정원 초과 → 대기 등록 → 취소 발생 → 대기자 결제

4. **동시성 테스트**
   - 2명 이상이 동시에 결제 시도 → 정원 초과 방지 확인

### 피드백 수집

- 결제 UX 개선점
- 취소 흐름 개선점
- 버그 리포트

---

## 5. 기술적 주의사항

### AI 에이전트 가이드

1. **포트원 웹훅 검증**
   - 웹훅 서명 검증 필수
   - 중복 웹훅 처리 방지 (idempotency)

2. **동시성 제어**
   - 정원 체크 시 `FOR UPDATE` 사용
   - 트랜잭션 내에서 체크 + 업데이트

3. **환불 규정 유연성**
   - 하드코딩 금지
   - refund_policies 테이블에서 조회

4. **에러 처리**
   - 결제 실패 시 registrations 정리
   - 사용자에게 명확한 안내

---

## 6. 다음 단계 (M3 준비)

M2 완료 후 M3 시작 전 확인:

- [ ] 솔라피 계정 생성
- [ ] 카카오 비즈니스 채널 준비
- [ ] 알림톡 템플릿 초안 작성 (카카오 승인 필요)

---

## 7. 애니메이션 요구사항

M2에서 구현할 UI 요소에 적용할 애니메이션입니다.

| UI 요소 | 애니메이션 | 구현 방식 |
|---------|----------|---------|
| 결제 완료 화면 | 체크마크 등장 | 원 그리기 + 체크 SVG 패스 애니메이션 |
| 참가 인원 증가 | 숫자 카운트업 | 이전 숫자 → 새 숫자 전환 (0.3초) |
| 마음 돌리기 화면 | 페이드인 + 슬라이드업 | Framer Motion variants |
| 대기 등록 완료 | 순위 뱃지 팝 | scale 0 → 1 + 바운스 |
| 취소 확인 모달 | 오버레이 페이드 | opacity 0 → 1 |
| 신청하기 버튼 | 클릭 피드백 | `whileTap={{ scale: 0.95 }}` |

### 마음 돌리기 화면 상세

취소 시도 시 표시되는 마음 돌리기 화면의 애니메이션:
- 배경: 오버레이 페이드인 (0.2초)
- 카드: 아래에서 슬라이드업 (0.3초, ease-out)
- 책 이미지: 스케일 인 (0.4초, 약간의 바운스)
- 텍스트: 순차적 페이드인 (Stagger 100ms)

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-14 | 1.0 | WP-M2 최초 작성 |
| 2026-01-15 | 1.1 | 애니메이션 요구사항 섹션 추가 (결제 완료, 마음 돌리기 등) |
| 2026-01-20 | 1.2 | Phase 6 계좌이체 결제 추가 |
| 2026-01-20 | 1.3 | Phase 6 계좌이체를 M5로 이동 (운영자 확인 필수 기능이므로) |

