# Work Package: M5 - 운영자 도구

---

**Milestone:** M5  
**목표:** 운영자 부담 최소화, 효율적인 운영 지원  
**기간:** 2주  
**선행 조건:** M3 완료 (알림 템플릿용), M4 완료 권장  
**핵심 가치:** 신뢰 (운영 관점)

---

## 1. Work Package 개요

M5는 **4개의 Phase**로 구성됩니다. 각 Phase가 끝나면 "동작하는" 소프트웨어 상태가 됩니다.

```
Phase 1: 대시보드
    ↓ [동작 확인: 이번 달 참가/수입/환불 통계 확인]
Phase 2: 알림 템플릿 관리
    ↓ [동작 확인: 알림 문구 수정 + 발송 on/off]
Phase 3: 권한 관리
    ↓ [동작 확인: 다른 운영진에게 권한 부여]
Phase 4: 요청함 & 배너 관리
    ↓ [동작 확인: 문의 답변 + 배너 관리]
```

---

## 2. Phase 상세

### Phase 1: 대시보드

**목표:** 운영자가 한눈에 현황 파악 가능

**예상 소요:** 3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.1 | 대시보드 레이아웃 | `/app/admin/dashboard/page.tsx` | 기본 구조 |
| 1.2 | 이번 달 참가 현황 | 통계 카드 | 확정/취소 건수 |
| 1.3 | 이번 달 수입 | 통계 카드 | 결제 금액 합계 |
| 1.4 | 환불 내역 | 통계 카드 | 환불 금액 합계 |
| 1.5 | 재참여율 | 통계 카드 | 월간 재참여 % |
| 1.6 | 세그먼트별 회원 수 | 차트/표 | 9개 세그먼트 |
| 1.7 | 모임별 현황 | 테이블 | 각 모임 참가자 수 |
| 1.8 | 통계 API | `/app/api/admin/stats/route.ts` | GET 요청 |
| 1.9 | 날짜 필터 | UI | 월 선택 |

#### 대시보드 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 대시보드                                   2026년 1월 ▼  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │
│ │ 📋 참가 현황   │ │ 💰 수입       │ │ 🔄 환불       │      │
│ │               │ │               │ │               │      │
│ │ 확정: 42건    │ │ 420,000콩    │ │ 30,000콩     │      │
│ │ 취소: 5건     │ │               │ │ (3건)        │      │
│ └───────────────┘ └───────────────┘ └───────────────┘      │
│                                                              │
│ ┌───────────────┐ ┌─────────────────────────────────────┐  │
│ │ 🔁 재참여율   │ │ 👥 회원 세그먼트                    │  │
│ │               │ │                                     │  │
│ │   68%        │ │ 신규: 12명 | 성장: 45명 | 충성: 80명 │  │
│ │               │ │ 이탈위험: 15명 | 자격만료임박: 8명   │  │
│ └───────────────┘ └─────────────────────────────────────┘  │
│                                                              │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ 📅 이번 달 모임 현황                                   │  │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 모임명              │ 일시         │ 참가  │ 상태     │  │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 경주 정기모임       │ 1/20 14:00   │ 12/14 │ 모집중   │  │
│ │ 포항 토론모임       │ 1/27 14:00   │ 14/14 │ 마감     │  │
│ │ 울산 정기모임       │ 2/3 14:00    │ 8/14  │ 모집중   │  │
│ └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

#### 통계 쿼리 예시

```sql
-- 이번 달 참가 현황
SELECT 
  COUNT(*) FILTER (WHERE status = 'confirmed') AS confirmed,
  COUNT(*) FILTER (WHERE status = 'cancelled') AS cancelled
FROM registrations
WHERE created_at >= DATE_TRUNC('month', CURRENT_DATE)
  AND created_at < DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month';

-- 이번 달 수입
SELECT COALESCE(SUM(payment_amount), 0) AS total_income
FROM registrations
WHERE payment_status = 'paid'
  AND created_at >= DATE_TRUNC('month', CURRENT_DATE);

-- 세그먼트별 회원 수 (동적 계산)
-- users 테이블에서 조건에 따라 분류
```

#### 완료 검증

- [ ] 대시보드에서 이번 달 참가 현황 확인
- [ ] 이번 달 수입/환불 금액 확인
- [ ] 재참여율 표시
- [ ] 세그먼트별 회원 수 표시
- [ ] 모임별 참가 현황 테이블 표시
- [ ] 월 선택으로 과거 데이터 조회 가능

#### 사용자 가치 (운영자)

> 🎯 **"운영자가 한 곳에서 전체 현황을 파악하고 의사결정할 수 있다"**

---

### Phase 2: 알림 템플릿 관리

**목표:** 운영자가 알림 문구 수정, 발송 on/off 가능

**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 2.1 | notification_templates 테이블 | SQL 마이그레이션 | 테이블 생성 |
| 2.2 | 기본 템플릿 시드 | 데이터 | 9개 템플릿 등록 |
| 2.3 | 템플릿 목록 화면 | `/app/admin/templates/page.tsx` | 목록 표시 |
| 2.4 | 템플릿 수정 화면 | `/app/admin/templates/[id]/edit/page.tsx` | 문구 수정 |
| 2.5 | 템플릿 수정 API | `/app/api/admin/templates/[id]/route.ts` | PUT 요청 |
| 2.6 | 발송 on/off 토글 | UI | 템플릿 활성화 제어 |
| 2.7 | 발송 시점 조정 | UI | 3일 전 → 2일 전 등 |
| 2.8 | 알림 발송 시 템플릿 조회 | 로직 수정 | DB에서 템플릿 사용 |
| 2.9 | 변수 미리보기 | UI | 치환 결과 확인 |

#### notification_templates 테이블

```sql
CREATE TABLE notification_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type VARCHAR(50) UNIQUE NOT NULL, -- reminder_3d, reminder_1d, waitlist, etc.
  name VARCHAR(100) NOT NULL,
  description TEXT,
  template_content TEXT NOT NULL,
  variables JSONB, -- ["회원명", "모임명", "날짜", ...]
  is_active BOOLEAN DEFAULT true,
  send_days_before INTEGER, -- 발송 기준 (모임 N일 전)
  send_time TIME, -- 발송 시간
  kakao_template_id VARCHAR(100), -- 카카오 승인 템플릿 ID
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 기본 템플릿 시드
INSERT INTO notification_templates (type, name, template_content, variables, send_days_before, send_time) VALUES
('reminder_3d', '모임 리마인드 (3일 전)', '[지독해] #{모임명} 리마인드\n\n안녕하세요, #{회원명}님!\n\n#{날짜} #{시간}에 #{모임명}이 있어요.\n\n📍 장소: #{장소}\n💰 참가비: #{참가비}콩', '["회원명", "모임명", "날짜", "시간", "장소", "참가비"]', 3, '07:00'),
('reminder_1d', '모임 리마인드 (1일 전)', '...', '...', 1, '07:00'),
('reminder_0d', '모임 리마인드 (당일)', '...', '...', 0, '07:00'),
('waitlist', '대기자 자리 발생', '...', '...', NULL, NULL),
('monthly', '월말 참여 독려', '...', '...', NULL, NULL),
('post_meeting', '모임 후 어떠셨어요', '...', '...', -3, '10:00'),
('welcome', '첫 모임 환영', '...', '...', 1, '20:00'),
('eligibility_warning', '자격 만료 임박', '...', '...', NULL, NULL),
('dormant_risk', '휴면 위험', '...', '...', NULL, NULL);
```

#### 템플릿 관리 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 📝 알림 템플릿 관리                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ● 모임 리마인드 (3일 전)                       [수정]   │ │
│ │   발송 시점: 모임 3일 전 오전 7시                        │ │
│ │   상태: ✅ 활성                             [비활성화]  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ● 모임 리마인드 (1일 전)                       [수정]   │ │
│ │   발송 시점: 모임 1일 전 오전 7시                        │ │
│ │   상태: ✅ 활성                             [비활성화]  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ 휴면 위험 알림                              [수정]   │ │
│ │   발송 시점: 마지막 참여 후 3개월                        │ │
│ │   상태: ⛔ 비활성                            [활성화]   │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 완료 검증

- [ ] 템플릿 목록에서 모든 알림 템플릿 확인
- [ ] 템플릿 문구 수정 가능
- [ ] 변수 치환 미리보기 확인
- [ ] 발송 on/off 토글 동작
- [ ] 발송 시점(N일 전) 변경 가능
- [ ] 수정된 템플릿으로 알림 발송됨

#### 사용자 가치 (운영자)

> 🎯 **"운영자가 알림 내용을 상황에 맞게 수정하고 관리할 수 있다"**

---

### Phase 3: 권한 관리

**목표:** 메인 운영자가 다른 운영진에게 권한 선택적 부여

**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 3.1 | admin_permissions 테이블 | SQL 마이그레이션 | 테이블 생성 |
| 3.2 | 권한 목록 정의 | 상수/enum | 6개 권한 |
| 3.3 | 운영자 목록 화면 | `/app/admin/permissions/page.tsx` | 운영자 리스트 |
| 3.4 | 권한 부여 화면 | `/app/admin/permissions/[id]/page.tsx` | 체크박스 |
| 3.5 | 권한 부여 API | `/app/api/admin/permissions/route.ts` | PUT 요청 |
| 3.6 | 권한 체크 미들웨어 | 미들웨어 수정 | 기능별 접근 제어 |
| 3.7 | 운영자 추가/삭제 | UI + API | 역할 변경 |

#### admin_permissions 테이블

```sql
CREATE TABLE admin_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) NOT NULL,
  permission VARCHAR(50) NOT NULL,
  granted_by UUID REFERENCES users(id),
  granted_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, permission)
);

-- 권한 종류
-- meeting_manage: 모임 생성/수정/삭제
-- notification_send: 알림톡 수동 발송
-- banner_manage: 배너 관리
-- request_answer: 요청함 답변
-- dashboard_view: 대시보드 열람
-- template_manage: 알림 템플릿 관리
```

#### 권한 체크 로직

```typescript
// /lib/permissions.ts
const PERMISSIONS = {
  MEETING_MANAGE: 'meeting_manage',
  NOTIFICATION_SEND: 'notification_send',
  BANNER_MANAGE: 'banner_manage',
  REQUEST_ANSWER: 'request_answer',
  DASHBOARD_VIEW: 'dashboard_view',
  TEMPLATE_MANAGE: 'template_manage',
} as const;

async function hasPermission(userId: string, permission: string): Promise<boolean> {
  const user = await getUser(userId);
  
  // super_admin은 모든 권한 보유
  if (user.role === 'super_admin') return true;
  
  // admin은 부여된 권한만
  if (user.role === 'admin') {
    const { data } = await supabase
      .from('admin_permissions')
      .select('permission')
      .eq('user_id', userId)
      .eq('permission', permission)
      .single();
    
    return !!data;
  }
  
  return false;
}
```

#### 권한 관리 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 👥 운영자 권한 관리                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 김운영 (super_admin)                                    │ │
│ │ 모든 권한 보유                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 박도움 (admin)                               [권한 수정] │ │
│ │ ✅ 모임 관리  ✅ 대시보드  ⬜ 알림 발송                  │ │
│ │ ⬜ 배너 관리  ⬜ 요청함    ⬜ 템플릿 관리                 │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 이보조 (admin)                               [권한 수정] │ │
│ │ ⬜ 모임 관리  ✅ 대시보드  ⬜ 알림 발송                  │ │
│ │ ✅ 배너 관리  ✅ 요청함    ⬜ 템플릿 관리                 │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│                              [+ 운영자 추가]                 │
└─────────────────────────────────────────────────────────────┘
```

#### 완료 검증

- [ ] super_admin이 다른 운영자에게 권한 부여 가능
- [ ] 권한별 체크박스로 선택적 부여
- [ ] 권한 없는 기능은 접근 불가 (403)
- [ ] 운영자 추가/삭제 가능
- [ ] 본인 권한 확인 가능

#### 사용자 가치 (운영자)

> 🎯 **"메인 운영자가 역할에 맞게 권한을 분배하여 협업할 수 있다"**

---

### Phase 4: 요청함 & 배너 관리

**목표:** 회원 문의 답변, 홈 화면 배너 관리

**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 4.1 | suggestions 테이블 확인 | 기존 활용 | 답변 필드 추가 |
| 4.2 | 요청함 목록 화면 | `/app/admin/requests/page.tsx` | 문의 목록 |
| 4.3 | 문의 상세 + 답변 | `/app/admin/requests/[id]/page.tsx` | 답변 입력 |
| 4.4 | 답변 저장 API | `/app/api/admin/requests/[id]/route.ts` | PUT 요청 |
| 4.5 | banners 테이블 생성 | SQL 마이그레이션 | 테이블 생성 |
| 4.6 | 배너 목록 화면 | `/app/admin/banners/page.tsx` | 배너 리스트 |
| 4.7 | 배너 등록/수정/삭제 | UI + API | CRUD |
| 4.8 | 배너 순서 관리 | 드래그 앤 드롭 | 순서 변경 |
| 4.9 | 홈 화면 배너 표시 | 홈 화면 수정 | 배너 슬라이드 |

#### suggestions 테이블 수정

```sql
-- 기존 테이블에 답변 필드 추가
ALTER TABLE suggestions ADD COLUMN IF NOT EXISTS
  answer TEXT,
  answered_by UUID REFERENCES users(id),
  answered_at TIMESTAMP,
  status VARCHAR(20) DEFAULT 'pending'; -- pending, answered, closed
```

#### banners 테이블

```sql
CREATE TABLE banners (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  image_url TEXT NOT NULL,
  link_url TEXT,
  position INTEGER NOT NULL, -- 순서
  is_active BOOLEAN DEFAULT true,
  start_date DATE,
  end_date DATE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 요청함 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 📬 요청함                                    미답변: 3건    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ● 2026-01-13 | 김독서                           [미답변]    │
│   "결제 후 환불 문의드립니다..."                             │
│                                                              │
│ ● 2026-01-12 | 박책방                           [미답변]    │
│   "장소 변경 가능한가요?"                                    │
│                                                              │
│ ○ 2026-01-10 | 이모임                           [답변완료]  │
│   "다음 달 일정은 언제 올라오나요?"                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 배너 관리 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 🎨 배너 관리                                    [+ 배너 추가] │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ≡ 1. 1월 신규 모임 안내                         ✅ 활성      │
│     ┌─────────────────────┐                    [수정] [삭제] │
│     │ [배너 이미지 썸네일] │                                  │
│     └─────────────────────┘                                  │
│                                                              │
│ ≡ 2. 연말 이벤트                               ⛔ 비활성    │
│     ┌─────────────────────┐                    [수정] [삭제] │
│     │ [배너 이미지 썸네일] │                                  │
│     └─────────────────────┘                                  │
│                                                              │
│ ※ 드래그하여 순서 변경                                       │
└─────────────────────────────────────────────────────────────┘
```

#### 완료 검증

- [ ] 요청함에서 문의 목록 확인
- [ ] 문의에 답변 작성 가능
- [ ] 답변 상태(미답변/답변완료) 구분 표시
- [ ] 배너 등록/수정/삭제 가능
- [ ] 배너 순서 드래그로 변경 가능
- [ ] 배너 활성/비활성 토글
- [ ] 홈 화면에 활성 배너 표시

#### 사용자 가치 (운영자)

> 🎯 **"운영자가 회원 문의에 답변하고, 홈 화면을 꾸밀 수 있다"**

---

## 3. M5 완료 검증 체크리스트

### 기능 검증

- [ ] 대시보드에서 참가/수입/환불 통계 확인
- [ ] 재참여율, 세그먼트별 회원 수 확인
- [ ] 알림 템플릿 문구 수정 가능
- [ ] 알림 발송 on/off 가능
- [ ] 다른 운영자에게 권한 선택적 부여 가능
- [ ] 권한 없는 기능 접근 불가
- [ ] 요청함 문의에 답변 가능
- [ ] 배너 관리 가능

### 보안 검증

- [ ] RLS 기반 권한 체크 동작
- [ ] super_admin만 권한 관리 가능
- [ ] admin은 부여된 권한만 사용 가능

---

## 4. 다음 단계 (M6 준비)

M5 완료 후 M6 시작 전 확인:

- [ ] 후킹 랜딩페이지 디자인 초안
- [ ] 공개 동의한 후기 조회 쿼리 준비
- [ ] SSR 최적화 방안 검토

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-14 | 1.0 | WP-M5 최초 작성 |

