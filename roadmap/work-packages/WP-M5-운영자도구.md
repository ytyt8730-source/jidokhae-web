# Work Package: M5 - 운영자 도구 + 계좌이체

---

**Milestone:** M5
**목표:** 운영자 부담 최소화, 효율적인 운영 지원, 계좌이체 결제 옵션 제공
**기간:** 2~3주
**선행 조건:** M3 완료 (알림 템플릿용), M4 완료 권장
**핵심 가치:** 신뢰 (운영 관점)

---

## 1. Work Package 개요

M5는 **4개의 Phase**로 구성됩니다. 각 Phase가 끝나면 "동작하는" 소프트웨어 상태가 됩니다.

> **Note:** 계좌이체 결제 기능이 M5에 통합되었습니다. 계좌이체는 운영자의 입금 확인이 필수이므로, 대시보드와 함께 Phase 1에서 구현합니다.

```
Phase 1: 대시보드 + 계좌이체 결제
    ↓ [동작 확인: 계좌이체 결제 + 운영자 입금 확인 + 통계 대시보드]
Phase 2: 알림 템플릿 관리
    ↓ [동작 확인: 알림 문구 수정 + 발송 on/off]
Phase 3: 권한 관리
    ↓ [동작 확인: 다른 운영진에게 권한 부여]
Phase 4: 요청함 & 배너 관리
    ↓ [동작 확인: 문의 답변 + 배너 관리]
```

---

## 2. Phase 상세

### Phase 1: 대시보드 + 계좌이체 결제

**목표:** 운영자가 한눈에 현황 파악 + 계좌이체 결제 옵션 제공

**예상 소요:** 5~6일

#### 작업 목록 (A: 대시보드)

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.1 | 대시보드 레이아웃 | `/app/admin/dashboard/page.tsx` | 기본 구조 |
| 1.2 | 이번 달 참가 현황 | 통계 카드 | 확정/취소 건수 |
| 1.3 | 이번 달 수입 | 통계 카드 | 결제 금액 합계 |
| 1.4 | 환불 내역 | 통계 카드 | 환불 금액 합계 |
| 1.5 | 재참여율 | 통계 카드 | 월간 재참여 % |
| 1.6 | 세그먼트별 회원 수 | 차트/표 | 9개 세그먼트 |
| 1.7 | 모임별 현황 | 테이블 | 각 모임 참가자 수 |
| 1.8 | 통계 API | `/app/api/admin/stats/route.ts` | GET 요청 |
| 1.9 | 날짜 필터 | UI | 월 선택 |

#### 작업 목록 (B: 계좌이체 - 사용자 측)

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.10 | 결제 방식 선택 UI | 신청 화면 수정 | 간편결제/계좌이체 탭 |
| 1.11 | 계좌 정보 표시 컴포넌트 | `TransferInfo.tsx` | 은행명, 계좌번호, 예금주 표시 |
| 1.12 | 입금자명 자동 생성 | 유틸 함수 | "MMDD_이름" 형식 |
| 1.13 | 클립보드 복사 기능 | UI 버튼 | 계좌번호, 입금자명 원터치 복사 |
| 1.14 | "입금했습니다" 체크 UI | 버튼 + 확인 모달 | 입금 완료 의사 확인 |
| 1.15 | 계좌이체 신청 API | `/api/registrations/transfer/route.ts` | pending_transfer 생성 + 정원 예약 |
| 1.16 | 입금대기 완료 화면 | 안내 페이지 | 입금 기한, 확인 절차 안내 |
| 1.17 | 환불 계좌 입력 UI | `RefundAccountModal.tsx` | 계좌이체 취소 시 환불 정보 수집 |
| 1.18 | 환불 계좌 저장 API | API 수정 | refund_info JSONB 저장 |
| 1.19 | 24시간 미입금 자동 취소 | `/api/cron/transfer-timeout/route.ts` | 기한 초과 건 자동 취소 + 정원 복구 |
| 1.20 | 입금 기한 임박 알림 | Cron 또는 트리거 | 6시간 전 경고 알림 |
| 1.21 | 마이페이지 입금대기 표시 | UI 수정 | 입금대기 상태 + 정보 다시보기 |
| 1.22 | 계좌이체 알림 템플릿 | notification_templates | 4종 추가 |

#### 작업 목록 (C: 계좌이체 - 운영자 측)

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.23 | 입금대기 건수 | 통계 카드 | 대시보드에 count 표시 |
| 1.24 | 입금대기 목록 | `/app/admin/transfers/page.tsx` | 모임별 필터, 입금자명 검색 |
| 1.25 | 입금 확인 API | `/api/admin/registrations/confirm/route.ts` | PUT 요청 |
| 1.26 | 입금 확인 버튼 | UI | 클릭 시 confirmed 상태 변경 |
| 1.27 | 수동 매칭 기능 | UI | 입금자명 불일치 시 운영자 매칭 |
| 1.28 | 환불대기 목록 | UI | 계좌이체 취소 건 환불 계좌 정보 |
| 1.29 | 환불 완료 체크 | `/api/admin/registrations/refund-complete/route.ts` | 운영자 환불 완료 표시 |

#### 대시보드 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 대시보드                                   2026년 1월 ▼  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │
│ │ 📋 참가 현황   │ │ 💰 수입       │ │ 🔄 환불       │      │
│ │               │ │               │ │               │      │
│ │ 확정: 42건    │ │ 420,000콩    │ │ 30,000콩     │      │
│ │ 취소: 5건     │ │               │ │ (3건)        │      │
│ └───────────────┘ └───────────────┘ └───────────────┘      │
│                                                              │
│ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │
│ │ ⏳ 입금대기    │ │ 💸 환불대기   │ │ 🔁 재참여율   │      │
│ │               │ │               │ │               │      │
│ │   **3건**     │ │   **2건**     │ │   68%        │      │
│ │ [확인하기 →]  │ │ [처리하기 →]  │ │               │      │
│ └───────────────┘ └───────────────┘ └───────────────┘      │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 👥 회원 세그먼트                                         │ │
│ │                                                          │ │
│ │ 신규: 12명 | 성장: 45명 | 충성: 80명                     │ │
│ │ 이탈위험: 15명 | 자격만료임박: 8명                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ 📅 이번 달 모임 현황                                   │  │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 모임명              │ 일시         │ 참가  │ 상태     │  │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 경주 정기모임       │ 1/20 14:00   │ 12/14 │ 모집중   │  │
│ │ 포항 토론모임       │ 1/27 14:00   │ 14/14 │ 마감     │  │
│ │ 울산 정기모임       │ 2/3 14:00    │ 8/14  │ 모집중   │  │
│ └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

#### 입금대기 목록 화면

```
┌─────────────────────────────────────────────────────────────┐
│ ⏳ 입금대기 목록                              [모임 필터 ▼]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ 🔍 입금자명 검색: [________________]                         │
│                                                              │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ 회원명    │ 입금자명     │ 금액     │ 기한        │ 액션 │ │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 홍길동   │ 0120_홍길동  │ 10,000콩 │ 1/21 14:00 │ [확인] │ │
│ │ 김철수   │ 0120_김철수  │ 10,000콩 │ 1/21 15:30 │ [확인] │ │
│ │ ⚠️ 박영희 │ 0120_박영희  │ 10,000콩 │ 1/20 18:00 │ [확인] │ │ ← 기한 임박
│ └───────────────────────────────────────────────────────┘  │
│                                                              │
│ ※ 입금자명이 실제 입금 내역과 다른 경우 [수동 매칭] 기능 사용 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 환불대기 목록 화면 (계좌이체 건)

```
┌─────────────────────────────────────────────────────────────┐
│ 💸 환불대기 목록 (계좌이체)                                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ 회원명   │ 모임명       │ 환불금액  │ 환불계좌         │ 액션 │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 홍길동  │ 경주 정기    │ 10,000콩 │ 카카오 3333-XX  │ [완료] │
│ │ 김철수  │ 포항 토론    │ 7,500콩  │ 신한 110-XXX    │ [완료] │
│ └───────────────────────────────────────────────────────┘  │
│                                                              │
│ [완료] 클릭 시: 실제 이체 완료 후 환불 처리 완료 표시          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 계좌이체 플로우 (사용자 측)

```
┌─────────────────────────────────────────────────────────────────┐
│ 사용자 플로우                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [신청하기] 클릭                                                  │
│       ↓                                                         │
│  결제 방식 선택: (●) 간편결제  (○) 계좌이체                        │
│       ↓                                                         │
│  계좌 정보 표시 ────────────────────────────────────┐            │
│  ┌─────────────────────────────────────────────┐   │            │
│  │ 💳 카카오뱅크 3333-XX-XXXXXX                 │   │            │
│  │ 📝 입금자명: 0120_홍길동                     │   │            │
│  │ 💰 금액: 10,000원                           │   │            │
│  │                                              │   │            │
│  │ [계좌번호 복사]  [입금자명 복사]              │   │            │
│  └─────────────────────────────────────────────┘   │            │
│       ↓                                            │            │
│  [입금했습니다] 클릭 ──→ 확인 모달                   │            │
│       ↓                                            │            │
│  registrations 생성                                 │            │
│  - status: 'pending_transfer'                      │            │
│  - payment_method: 'transfer'                      │            │
│  - payment_status: 'pending'                       │            │
│  - transfer_deadline: NOW() + 24h                  │            │
│  - current_participants: +1 (정원 예약)             │            │
│       ↓                                            │            │
│  [알림톡] 입금 안내 발송                             │            │
│       ↓                                            │            │
│  입금대기 안내 화면                                  │            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 계좌이체 플로우 (운영자 확인)

```
┌─────────────────────────────────────────────────────────────────┐
│ 운영자 확인 플로우                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  운영자: 통장 입금 내역 확인                                      │
│       ↓                                                         │
│  대시보드 → 입금대기 목록 → 해당 건 선택                          │
│       ↓                                                         │
│  [입금 확인] 버튼 클릭                                           │
│       ↓                                                         │
│  registrations 업데이트                                          │
│  - status: 'confirmed'                                          │
│  - payment_status: 'paid'                                       │
│       ↓                                                         │
│  [알림톡] 참가 확정 알림 발송                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 24시간 미입금 자동 취소 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│ 자동 취소 플로우 (24시간 미입금)                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Cron Job (매 시간 실행)                                         │
│       ↓                                                         │
│  transfer_deadline < NOW() AND status = 'pending_transfer' 조회  │
│       ↓                                                         │
│  registrations 업데이트                                          │
│  - status: 'cancelled'                                          │
│  - cancel_reason: 'transfer_expired'                            │
│  - current_participants: -1 (정원 복구)                          │
│       ↓                                                         │
│  [알림톡] 자동 취소 안내 발송                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 환불 계좌 수집 (계좌이체 건 취소 시)

```
┌─────────────────────────────────────────────────────────────────┐
│ 환불 계좌 입력 모달                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⚠️ 계좌이체 건은 수동 환불됩니다                                 │
│                                                                  │
│  환불받을 계좌 정보를 입력해주세요.                               │
│                                                                  │
│  은행명:    [카카오뱅크      ▼]                                  │
│  계좌번호:  [                  ]                                 │
│  예금주:    [                  ]                                 │
│                                                                  │
│  💰 환불 예정 금액: 10,000콩 (100%)                              │
│  ⏰ 환불 소요: 영업일 1~2일                                       │
│                                                                  │
│  [취소]  [환불 신청하기]                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

저장 위치: registrations.refund_info (JSONB)
{
  "bank": "카카오뱅크",
  "account": "3333-XX-XXXXXX",
  "holder": "홍길동",
  "requested_at": "2026-01-20T10:00:00Z"
}
```

#### 정원 관리 규칙 (중요)

계좌이체는 간편결제와 달리 확정까지 시간이 걸리므로, **정원 즉시 예약** 방식 적용:

| 이벤트 | current_participants | 비고 |
|--------|---------------------|------|
| 계좌이체 "입금했습니다" 클릭 | **+1** | 정원 예약 (pending_transfer 상태) |
| 운영자 입금 확인 | 변화 없음 | 이미 예약됨 |
| 24시간 미입금 자동 취소 | **-1** | 정원 복구 |
| 사용자 취소 (입금 전) | **-1** | 정원 복구 |

※ 기존 포트원 결제는 `confirmed` 시점에 +1 (변경 없음)

#### 계좌이체 알림 템플릿 (4종)

| 코드 | 명칭 | 발송 시점 | 내용 요약 |
|------|------|----------|----------|
| `TRANSFER_PENDING` | 입금 안내 | 입금완료 체크 직후 | 계좌번호, 입금자명, 금액, 기한 |
| `TRANSFER_DEADLINE_WARNING` | 입금 기한 임박 | 기한 6시간 전 | 미입금 시 자동취소 경고 |
| `TRANSFER_CONFIRMED` | 참가 확정 | 운영자 승인 시 | 입금 확인 + 모임 정보 |
| `TRANSFER_EXPIRED` | 미입금 자동 취소 | 24시간 초과 시 | 자동 취소 안내 + 재신청 유도 |

#### 통계 쿼리 예시

```sql
-- 이번 달 참가 현황
SELECT 
  COUNT(*) FILTER (WHERE status = 'confirmed') AS confirmed,
  COUNT(*) FILTER (WHERE status = 'cancelled') AS cancelled
FROM registrations
WHERE created_at >= DATE_TRUNC('month', CURRENT_DATE)
  AND created_at < DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month';

-- 이번 달 수입
SELECT COALESCE(SUM(payment_amount), 0) AS total_income
FROM registrations
WHERE payment_status = 'paid'
  AND created_at >= DATE_TRUNC('month', CURRENT_DATE);

-- 세그먼트별 회원 수 (동적 계산)
-- users 테이블에서 조건에 따라 분류
```

#### 완료 검증

- [ ] 대시보드에서 이번 달 참가 현황 확인
- [ ] 이번 달 수입/환불 금액 확인
- [ ] 재참여율 표시
- [ ] 세그먼트별 회원 수 표시
- [ ] 모임별 참가 현황 테이블 표시
- [ ] 월 선택으로 과거 데이터 조회 가능
- [ ] **입금대기 건수 표시 + 클릭 시 목록 이동**
- [ ] **입금대기 목록에서 입금자명 검색 가능**
- [ ] **입금 확인 버튼 클릭 시 confirmed 상태 변경**
- [ ] **환불대기 목록에서 환불 계좌 정보 확인**
- [ ] **환불 완료 버튼 클릭 시 refunded 상태 변경**

#### 사용자 가치 (운영자)

> 🎯 **"운영자가 한 곳에서 전체 현황을 파악하고, 계좌이체 건을 효율적으로 관리할 수 있다"**

---

### Phase 2: 알림 템플릿 관리

**목표:** 운영자가 알림 문구 수정, 발송 on/off 가능

**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 2.1 | notification_templates 테이블 | SQL 마이그레이션 | 테이블 생성 |
| 2.2 | 기본 템플릿 시드 | 데이터 | 9개 템플릿 등록 |
| 2.3 | 템플릿 목록 화면 | `/app/admin/templates/page.tsx` | 목록 표시 |
| 2.4 | 템플릿 수정 화면 | `/app/admin/templates/[id]/edit/page.tsx` | 문구 수정 |
| 2.5 | 템플릿 수정 API | `/app/api/admin/templates/[id]/route.ts` | PUT 요청 |
| 2.6 | 발송 on/off 토글 | UI | 템플릿 활성화 제어 |
| 2.7 | 발송 시점 조정 | UI | 3일 전 → 2일 전 등 |
| 2.8 | 알림 발송 시 템플릿 조회 | 로직 수정 | DB에서 템플릿 사용 |
| 2.9 | 변수 미리보기 | UI | 치환 결과 확인 |

#### notification_templates 테이블

```sql
CREATE TABLE notification_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type VARCHAR(50) UNIQUE NOT NULL, -- reminder_3d, reminder_1d, waitlist, etc.
  name VARCHAR(100) NOT NULL,
  description TEXT,
  template_content TEXT NOT NULL,
  variables JSONB, -- ["회원명", "모임명", "날짜", ...]
  is_active BOOLEAN DEFAULT true,
  send_days_before INTEGER, -- 발송 기준 (모임 N일 전)
  send_time TIME, -- 발송 시간
  kakao_template_id VARCHAR(100), -- 카카오 승인 템플릿 ID
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 기본 템플릿 시드
INSERT INTO notification_templates (type, name, template_content, variables, send_days_before, send_time) VALUES
('reminder_3d', '모임 리마인드 (3일 전)', '[지독해] #{모임명} 리마인드\n\n안녕하세요, #{회원명}님!\n\n#{날짜} #{시간}에 #{모임명}이 있어요.\n\n📍 장소: #{장소}\n💰 참가비: #{참가비}콩', '["회원명", "모임명", "날짜", "시간", "장소", "참가비"]', 3, '07:00'),
('reminder_1d', '모임 리마인드 (1일 전)', '...', '...', 1, '07:00'),
('reminder_0d', '모임 리마인드 (당일)', '...', '...', 0, '07:00'),
('waitlist', '대기자 자리 발생', '...', '...', NULL, NULL),
('monthly', '월말 참여 독려', '...', '...', NULL, NULL),
('post_meeting', '모임 후 어떠셨어요', '...', '...', -3, '10:00'),
('welcome', '첫 모임 환영', '...', '...', 1, '20:00'),
('eligibility_warning', '자격 만료 임박', '...', '...', NULL, NULL),
('dormant_risk', '휴면 위험', '...', '...', NULL, NULL);
```

#### 템플릿 관리 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 📝 알림 템플릿 관리                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ● 모임 리마인드 (3일 전)                       [수정]   │ │
│ │   발송 시점: 모임 3일 전 오전 7시                        │ │
│ │   상태: ✅ 활성                             [비활성화]  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ● 모임 리마인드 (1일 전)                       [수정]   │ │
│ │   발송 시점: 모임 1일 전 오전 7시                        │ │
│ │   상태: ✅ 활성                             [비활성화]  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ 휴면 위험 알림                              [수정]   │ │
│ │   발송 시점: 마지막 참여 후 3개월                        │ │
│ │   상태: ⛔ 비활성                            [활성화]   │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 완료 검증

- [ ] 템플릿 목록에서 모든 알림 템플릿 확인
- [ ] 템플릿 문구 수정 가능
- [ ] 변수 치환 미리보기 확인
- [ ] 발송 on/off 토글 동작
- [ ] 발송 시점(N일 전) 변경 가능
- [ ] 수정된 템플릿으로 알림 발송됨

#### 사용자 가치 (운영자)

> 🎯 **"운영자가 알림 내용을 상황에 맞게 수정하고 관리할 수 있다"**

---

### Phase 3: 권한 관리

**목표:** 메인 운영자가 다른 운영진에게 권한 선택적 부여

**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 3.1 | admin_permissions 테이블 | SQL 마이그레이션 | 테이블 생성 |
| 3.2 | 권한 목록 정의 | 상수/enum | 6개 권한 |
| 3.3 | 운영자 목록 화면 | `/app/admin/permissions/page.tsx` | 운영자 리스트 |
| 3.4 | 권한 부여 화면 | `/app/admin/permissions/[id]/page.tsx` | 체크박스 |
| 3.5 | 권한 부여 API | `/app/api/admin/permissions/route.ts` | PUT 요청 |
| 3.6 | 권한 체크 미들웨어 | 미들웨어 수정 | 기능별 접근 제어 |
| 3.7 | 운영자 추가/삭제 | UI + API | 역할 변경 |

#### admin_permissions 테이블

```sql
CREATE TABLE admin_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) NOT NULL,
  permission VARCHAR(50) NOT NULL,
  granted_by UUID REFERENCES users(id),
  granted_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, permission)
);

-- 권한 종류
-- meeting_manage: 모임 생성/수정/삭제
-- notification_send: 알림톡 수동 발송
-- banner_manage: 배너 관리
-- request_answer: 요청함 답변
-- dashboard_view: 대시보드 열람
-- template_manage: 알림 템플릿 관리
```

#### 권한 체크 로직

```typescript
// /lib/permissions.ts
const PERMISSIONS = {
  MEETING_MANAGE: 'meeting_manage',
  NOTIFICATION_SEND: 'notification_send',
  BANNER_MANAGE: 'banner_manage',
  REQUEST_ANSWER: 'request_answer',
  DASHBOARD_VIEW: 'dashboard_view',
  TEMPLATE_MANAGE: 'template_manage',
} as const;

async function hasPermission(userId: string, permission: string): Promise<boolean> {
  const user = await getUser(userId);
  
  // super_admin은 모든 권한 보유
  if (user.role === 'super_admin') return true;
  
  // admin은 부여된 권한만
  if (user.role === 'admin') {
    const { data } = await supabase
      .from('admin_permissions')
      .select('permission')
      .eq('user_id', userId)
      .eq('permission', permission)
      .single();
    
    return !!data;
  }
  
  return false;
}
```

#### 권한 관리 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 👥 운영자 권한 관리                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 김운영 (super_admin)                                    │ │
│ │ 모든 권한 보유                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 박도움 (admin)                               [권한 수정] │ │
│ │ ✅ 모임 관리  ✅ 대시보드  ⬜ 알림 발송                  │ │
│ │ ⬜ 배너 관리  ⬜ 요청함    ⬜ 템플릿 관리                 │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 이보조 (admin)                               [권한 수정] │ │
│ │ ⬜ 모임 관리  ✅ 대시보드  ⬜ 알림 발송                  │ │
│ │ ✅ 배너 관리  ✅ 요청함    ⬜ 템플릿 관리                 │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│                              [+ 운영자 추가]                 │
└─────────────────────────────────────────────────────────────┘
```

#### 완료 검증

- [ ] super_admin이 다른 운영자에게 권한 부여 가능
- [ ] 권한별 체크박스로 선택적 부여
- [ ] 권한 없는 기능은 접근 불가 (403)
- [ ] 운영자 추가/삭제 가능
- [ ] 본인 권한 확인 가능

#### 사용자 가치 (운영자)

> 🎯 **"메인 운영자가 역할에 맞게 권한을 분배하여 협업할 수 있다"**

---

### Phase 4: 요청함 & 배너 관리

**목표:** 회원 문의 답변, 홈 화면 배너 관리

**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 4.1 | suggestions 테이블 확인 | 기존 활용 | 답변 필드 추가 |
| 4.2 | 요청함 목록 화면 | `/app/admin/requests/page.tsx` | 문의 목록 |
| 4.3 | 문의 상세 + 답변 | `/app/admin/requests/[id]/page.tsx` | 답변 입력 |
| 4.4 | 답변 저장 API | `/app/api/admin/requests/[id]/route.ts` | PUT 요청 |
| 4.5 | banners 테이블 생성 | SQL 마이그레이션 | 테이블 생성 |
| 4.6 | 배너 목록 화면 | `/app/admin/banners/page.tsx` | 배너 리스트 |
| 4.7 | 배너 등록/수정/삭제 | UI + API | CRUD |
| 4.8 | 배너 순서 관리 | 드래그 앤 드롭 | 순서 변경 |
| 4.9 | 홈 화면 배너 표시 | 홈 화면 수정 | 배너 슬라이드 |

#### suggestions 테이블 수정

```sql
-- 기존 테이블에 답변 필드 추가
ALTER TABLE suggestions ADD COLUMN IF NOT EXISTS
  answer TEXT,
  answered_by UUID REFERENCES users(id),
  answered_at TIMESTAMP,
  status VARCHAR(20) DEFAULT 'pending'; -- pending, answered, closed
```

#### banners 테이블

```sql
CREATE TABLE banners (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  image_url TEXT NOT NULL,
  link_url TEXT,
  position INTEGER NOT NULL, -- 순서
  is_active BOOLEAN DEFAULT true,
  start_date DATE,
  end_date DATE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 요청함 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 📬 요청함                                    미답변: 3건    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ● 2026-01-13 | 김독서                           [미답변]    │
│   "결제 후 환불 문의드립니다..."                             │
│                                                              │
│ ● 2026-01-12 | 박책방                           [미답변]    │
│   "장소 변경 가능한가요?"                                    │
│                                                              │
│ ○ 2026-01-10 | 이모임                           [답변완료]  │
│   "다음 달 일정은 언제 올라오나요?"                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 배너 관리 화면

```
┌─────────────────────────────────────────────────────────────┐
│ 🎨 배너 관리                                    [+ 배너 추가] │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ≡ 1. 1월 신규 모임 안내                         ✅ 활성      │
│     ┌─────────────────────┐                    [수정] [삭제] │
│     │ [배너 이미지 썸네일] │                                  │
│     └─────────────────────┘                                  │
│                                                              │
│ ≡ 2. 연말 이벤트                               ⛔ 비활성    │
│     ┌─────────────────────┐                    [수정] [삭제] │
│     │ [배너 이미지 썸네일] │                                  │
│     └─────────────────────┘                                  │
│                                                              │
│ ※ 드래그하여 순서 변경                                       │
└─────────────────────────────────────────────────────────────┘
```

#### 완료 검증

- [ ] 요청함에서 문의 목록 확인
- [ ] 문의에 답변 작성 가능
- [ ] 답변 상태(미답변/답변완료) 구분 표시
- [ ] 배너 등록/수정/삭제 가능
- [ ] 배너 순서 드래그로 변경 가능
- [ ] 배너 활성/비활성 토글
- [ ] 홈 화면에 활성 배너 표시

#### 사용자 가치 (운영자)

> 🎯 **"운영자가 회원 문의에 답변하고, 홈 화면을 꾸밀 수 있다"**

---

## 3. M5 완료 검증 체크리스트

### 기능 검증

- [ ] 대시보드에서 참가/수입/환불 통계 확인
- [ ] 재참여율, 세그먼트별 회원 수 확인
- [ ] 알림 템플릿 문구 수정 가능
- [ ] 알림 발송 on/off 가능
- [ ] 다른 운영자에게 권한 선택적 부여 가능
- [ ] 권한 없는 기능 접근 불가
- [ ] 요청함 문의에 답변 가능
- [ ] 배너 관리 가능

### 보안 검증

- [ ] RLS 기반 권한 체크 동작
- [ ] super_admin만 권한 관리 가능
- [ ] admin은 부여된 권한만 사용 가능

---

## 4. 다음 단계 (M6 준비)

M5 완료 후 M6 시작 전 확인:

- [ ] 후킹 랜딩페이지 디자인 초안
- [ ] 공개 동의한 후기 조회 쿼리 준비
- [ ] SSR 최적화 방안 검토

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-14 | 1.0 | WP-M5 최초 작성 |
| 2026-01-20 | 1.1 | Phase 1에 입금대기/환불대기 관리 기능 추가 (계좌이체 지원) |

