# 운영자 직접 작업 목록

개발 과정에서 발생하는 **운영자가 직접 처리해야 하는 작업들**을 관리합니다.

---

## M6-Onboarding 준비 작업

M6-Onboarding 구현 전 운영자가 직접 완료해야 하는 작업입니다.

### 1. 솔라피 알림톡 템플릿 등록

#### 카카오 알림톡 심사 기준 (M6-Onboarding)

> **중요:** 아래 템플릿 중 **환영 메시지를 제외한 모든 템플릿은 마케팅/광고성**으로 분류될 가능성이 높습니다.
>
> **대안:**
> - 친구톡 (광고성 메시지 허용, 수신 동의 필요)
> - 문자 SMS/LMS (광고 표기 필요)

#### 등록해야 할 템플릿 (5개)

| 순서 | 템플릿 코드 | 용도 | 우선순위 | 반려 위험 | 상태 |
|:----:|-------------|------|:--------:|:--------:|:----:|
| 1 | `SIGNUP_WELCOME` | 가입 직후 환영 | 높음 | 낮음 | [ ] |
| 2 | `SIGNUP_REMINDER_DAY3` | 가입 후 3일 미신청 | 높음 | **높음** | [ ] |
| 3 | `SIGNUP_REMINDER_DAY7` | 가입 후 7일 미신청 | 중간 | **높음** | [ ] |
| 4 | `FIRST_MEETING_DAY3` | 첫 모임 후 3일 | 중간 | **높음** | [ ] |
| 5 | `FIRST_MEETING_DAY7` | 첫 모임 후 7일 미신청 | 중간 | **높음** | [ ] |

---

#### 템플릿 1: SIGNUP_WELCOME (가입 직후 환영) - 반려 위험: 낮음

**발송 타이밍:** 회원가입 즉시

**강조 제목:** `낮과 밤의 서재 가입 완료`

**본문:**
```
#{이름}님, 낮과 밤의 서재 가입이 완료되었습니다.

이제 독서 모임에 신청하실 수 있습니다.
모임 일정과 참여 방법을 확인해보세요.
```

**버튼:** 모임 확인하기 → `https://jidokhae.com`

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |

---

#### 템플릿 2: SIGNUP_REMINDER_DAY3 (가입 후 3일) - 반려 위험: 높음

> **경고:** 미신청자 대상 참여 유도 메시지로 반려될 가능성이 높습니다.
> **대안:** 친구톡 또는 문자(SMS/LMS)로 발송 검토

**발송 타이밍:** 가입 후 3일, 모임 미신청 시 (매일 10:00)

**강조 제목:** `모임 신청 안내`

**본문:**
```
#{이름}님, 가입 후 모임 신청 내역이 없어 안내드립니다.

현재 진행 중인 #{요일} #{지역} 모임에 #{남은자리}자리가 남아있습니다.

모임 상세 정보와 신청 방법을 확인하실 수 있습니다.
```

**버튼:** 모임 확인하기 → `https://jidokhae.com`

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{요일}` | 모임 요일 | 토요일 |
| `#{지역}` | 모임 지역 | 경주 |
| `#{남은자리}` | 남은 좌석 수 | 3 |

---

#### 템플릿 3: SIGNUP_REMINDER_DAY7 (가입 후 7일) - 반려 위험: 높음

> **경고:** 미신청자 대상 참여 유도 메시지로 반려될 가능성이 높습니다.
> **대안:** 친구톡 또는 문자(SMS/LMS)로 발송 검토

**발송 타이밍:** 가입 후 7일, 모임 미신청 시 (매일 10:00)

**강조 제목:** `모임 참여 안내`

**본문:**
```
#{이름}님, 가입 후 7일이 경과하여 안내드립니다.

아직 모임 신청 내역이 없습니다.
다음 모임 일정과 참여 방법을 확인하실 수 있습니다.
```

**버튼:** 모임 확인하기 → `https://jidokhae.com`

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |

---

#### 템플릿 4: FIRST_MEETING_DAY3 (첫 모임 후 3일) - 반려 위험: 높음

> **경고:** 다음 모임 참여 유도 메시지로 반려될 가능성이 높습니다.
> **대안:** 친구톡 또는 문자(SMS/LMS)로 발송 검토

**발송 타이밍:** 첫 정기모임 참여 완료 후 3일 (매일 10:00)

**강조 제목:** `모임 참여 내역 안내`

**본문:**
```
#{이름}님, #{모임명} 모임 참여가 완료되었습니다.

다음 모임 일정:
- 일시: #{다음모임일시}
- 현재 신청: #{신청인원}명

모임 상세 정보를 확인하실 수 있습니다.
```

**버튼:** 모임 확인하기 → `https://jidokhae.com`

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{모임명}` | 참여한 모임 제목 | 데미안 |
| `#{다음모임일시}` | 다음 모임 일시 | 2월 15일 토요일 오후 2시 |
| `#{신청인원}` | 현재 신청 인원 | 4 |

---

#### 템플릿 5: FIRST_MEETING_DAY7 (첫 모임 후 7일) - 반려 위험: 높음

> **경고:** 다음 모임 참여 유도 메시지로 반려될 가능성이 높습니다.
> **대안:** 친구톡 또는 문자(SMS/LMS)로 발송 검토

**발송 타이밍:** 첫 정기모임 참여 완료 후 7일, 두 번째 모임 미신청 시 (매일 10:00)

**강조 제목:** `다음 모임 일정 안내`

**본문:**
```
#{이름}님, 다음 모임 일정을 안내드립니다.

#{지역} 모임 정보:
- 도서: #{책제목}
- 잔여 좌석: #{남은자리}석

모임 상세 정보와 신청 방법을 확인하실 수 있습니다.
```

**버튼:** 모임 확인하기 → `https://jidokhae.com`

> **코드 수정 필요:** `onboarding-first-meeting/route.ts` - 현재 `이름`, `모임명`, `다음모임일시`, `신청인원`, `책제목` 전송. `지역`, `남은자리` 변수 추가 필요.

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{지역}` | 모임 지역 | 경주 |
| `#{책제목}` | 모임 책 제목 | 1984 |
| `#{남은자리}` | 남은 좌석 수 | 2 |

---

#### 솔라피 템플릿 등록 절차 (강조표기형)

**1단계: 솔라피 콘솔 접속**
1. [솔라피 콘솔](https://console.solapi.com) 접속
2. 로그인 후 좌측 메뉴에서 **알림톡** 선택

**2단계: 템플릿 등록 메뉴**
1. **알림톡 > 템플릿 관리** 메뉴 클릭
2. 우측 상단 **템플릿 등록** 버튼 클릭

**3단계: 템플릿 유형 선택**
1. **강조표기형** 선택 (제목 + 본문 형식)
2. 강조 제목: 50자 이내 (위 템플릿의 "강조 제목" 참고)
3. 본문: 위 템플릿의 "본문" 내용 입력

**4단계: 템플릿 작성**
1. **템플릿 코드**: 위 표의 코드 입력 (예: `SIGNUP_WELCOME`)
2. **카테고리**: 용도에 맞는 카테고리 선택 (아래 표 참조)
3. **강조 제목**: 위 템플릿의 강조 제목 입력
4. **본문 내용**: 위 템플릿의 본문 그대로 복사
5. **버튼 설정**: 웹링크 버튼 추가, URL 입력

**카테고리 선택 가이드:**
| 템플릿 유형 | 카테고리 |
|-------------|----------|
| SIGNUP_WELCOME, 온보딩 관련 | 회원/가입/인증 |
| TRANSFER_DEADLINE_WARNING, 입금 관련 | 결제/구매 |
| REMINDER_3D, WAITLIST_EXPIRED | 예약/주문 |
| ELIGIBILITY_WARNING | 회원/가입/인증 |
| PRAISE_NUDGE | 회원/가입/인증 |
| ADMIN_NOTICE | 공지/안내 |

**5단계: 변수 예시 텍스트 입력 (필수)**
> **중요:** 모든 심사 대상 템플릿의 변수에는 **예시 텍스트**가 포함되어야 합니다.

각 변수 옆 "예시 텍스트" 입력란에 실제 발송될 내용 예시 작성:
- `#{이름}` → 예시: `김지독`
- `#{모임명}` → 예시: `데미안`
- `#{일시}` → 예시: `2월 15일 토요일 오후 2시`

**6단계: 미리보기 메시지 설정 (선택)**
> 알림톡 푸시 알림에 표시되는 미리보기 문구

- 한글/영문 띄어쓰기 포함 **최대 40자**
- **변수 사용 불가** (고정 문구만)
- 보안 템플릿은 설정 불가
- 예시: `낮과 밤의 서재에서 알림이 도착했습니다`

**7단계: 주의사항**
- 이모지 사용 금지 (검수 반려 사유)
- 변수는 반드시 `#{변수명}` 형식으로 작성
- **광고성 표현 절대 금지** (반려 주요 사유)
  - 금지 예시: "함께해요", "기다리고 있어요", "놓치지 마세요"
  - 허용 예시: "안내드립니다", "확인하실 수 있습니다"
- **변수만으로 구성된 본문 금지** (반려 사유)
- 버튼 URL은 https:// 포함 전체 경로
- 강조 제목 50자 초과 시 반려

**8단계: 검수 요청**
1. 템플릿 저장 후 **검수 요청** 버튼 클릭
2. 검수 소요 시간: 1~3 영업일
3. 검수 결과는 이메일/SMS로 통보
4. **반려 시**: 사유 확인 후 수정하여 재등록

**9단계: 승인 후 템플릿 ID 기록**
1. 검수 승인되면 템플릿 상세에서 **템플릿 ID** 확인
2. 아래 표에 기록

---

#### 이미지 활용 (선택사항)

> 브랜딩 강화를 위해 로고형/아이콘형 이미지를 추가할 수 있습니다.

**이미지 유형:**
| 유형 | 크기 | 용도 |
|------|------|------|
| 로고형 | 800x400px | 브랜드 로고 노출 (상단) |
| 아이콘형 | 108x108px | 작은 아이콘 (제목 옆) |

**권장 사용:**
- 중요 알림 (결제, 일정 안내)에 로고형 이미지 추가
- 브랜드 인지도 향상 효과

**등록 방법:**
1. 템플릿 등록 시 "이미지 추가" 선택
2. 이미지 유형 선택 (로고형/아이콘형)
3. 이미지 파일 업로드 (JPG, PNG)

---

#### 승인된 템플릿 ID 기록

| 템플릿 코드 | 솔라피 템플릿 ID | 승인일 |
|-------------|------------------|--------|
| `SIGNUP_WELCOME` |  |  |
| `SIGNUP_REMINDER_DAY3` |  |  |
| `SIGNUP_REMINDER_DAY7` |  |  |
| `FIRST_MEETING_DAY3` |  |  |
| `FIRST_MEETING_DAY7` |  |  |

---

### 2. DB 마이그레이션 (Phase 1 전 필수)

**실행 위치:** Supabase Dashboard > SQL Editor

**실행 전 확인사항:**
- [ ] 프로덕션 DB 백업 완료
- [ ] 로컬/스테이징에서 먼저 테스트 완료

**실행할 SQL:**

```sql
-- M6-Onboarding: users 테이블 확장
-- 실행일: ____년 __월 __일

-- 1. 온보딩 진행 단계 (1~5)
ALTER TABLE users ADD COLUMN IF NOT EXISTS onboarding_step INTEGER DEFAULT 1;

-- 2. 온보딩 완료 시점
ALTER TABLE users ADD COLUMN IF NOT EXISTS onboarding_completed_at TIMESTAMPTZ;

-- 3. 문제 인식 단계에서 선택한 항목 (JSONB 배열)
ALTER TABLE users ADD COLUMN IF NOT EXISTS problem_selections JSONB DEFAULT '[]';

-- 4. 1차 Aha Moment 달성 시점 (칭찬 보내기)
ALTER TABLE users ADD COLUMN IF NOT EXISTS first_aha_at TIMESTAMPTZ;

-- 5. 2차 Aha Moment 달성 시점 (칭찬 받기)
ALTER TABLE users ADD COLUMN IF NOT EXISTS second_aha_at TIMESTAMPTZ;

-- 6. 가입 후 리마인드 마지막 발송 시점
ALTER TABLE users ADD COLUMN IF NOT EXISTS signup_reminder_sent_at TIMESTAMPTZ;

-- 7. 가입 후 리마인드 발송 횟수 (14일 규칙: 2회 후 중단)
ALTER TABLE users ADD COLUMN IF NOT EXISTS signup_reminder_count INTEGER DEFAULT 0;

-- 8. 인덱스: 온보딩 진행 상태 조회 최적화
CREATE INDEX IF NOT EXISTS idx_users_onboarding
  ON users(onboarding_step, is_new_member);

-- 9. 인덱스: 가입 후 리마인드 대상 조회 최적화
CREATE INDEX IF NOT EXISTS idx_users_signup_reminder
  ON users(created_at, signup_reminder_count)
  WHERE is_new_member = true;
```

**실행 방법:**
1. [Supabase Dashboard](https://supabase.com/dashboard) 접속
2. 프로젝트 선택
3. 좌측 메뉴 **SQL Editor** 클릭
4. **New query** 클릭
5. 위 SQL 전체 복사하여 붙여넣기
6. **Run** 버튼 클릭

**실행 후 확인:**
```sql
-- 컬럼 추가 확인
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'users'
  AND column_name IN (
    'onboarding_step',
    'onboarding_completed_at',
    'problem_selections',
    'first_aha_at',
    'second_aha_at',
    'signup_reminder_sent_at',
    'signup_reminder_count'
  );

-- 인덱스 확인
SELECT indexname FROM pg_indexes
WHERE tablename = 'users'
  AND indexname LIKE 'idx_users_%';
```

**완료 체크리스트:**
- [x] SQL 실행 완료 ✅ 2026-02-04
- [x] 7개 컬럼 추가 확인 ✅
- [x] 2개 인덱스 생성 확인 ✅
- [x] 기존 데이터 영향 없음 확인 ✅

---

### 2-1. DB 마이그레이션 추가 (Phase 4 & 5용) ✅ 완료

**실행 위치:** Supabase Dashboard > SQL Editor

**필요 시점:** Phase 4 & 5 구현 완료 후

**실행할 SQL:**

```sql
-- M6-Onboarding Phase 4 & 5: 첫 모임 후 리마인드 컬럼
-- 실행일: ____년 __월 __일

-- 1. 첫 모임 후 리마인드 발송 횟수 (14일 규칙: 2회 후 중단)
ALTER TABLE users ADD COLUMN IF NOT EXISTS first_meeting_reminder_count INTEGER DEFAULT 0;

-- 2. 첫 모임 후 리마인드 마지막 발송 시점
ALTER TABLE users ADD COLUMN IF NOT EXISTS first_meeting_reminder_sent_at TIMESTAMPTZ;

-- 3. 인덱스: 첫 모임 후 리마인드 대상 조회 최적화
CREATE INDEX IF NOT EXISTS idx_users_first_meeting_reminder
  ON users(first_regular_meeting_at, first_meeting_reminder_count)
  WHERE first_regular_meeting_at IS NOT NULL;
```

**실행 후 확인:**
```sql
-- 컬럼 추가 확인
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'users'
  AND column_name IN (
    'first_meeting_reminder_count',
    'first_meeting_reminder_sent_at'
  );

-- 인덱스 확인
SELECT indexname FROM pg_indexes
WHERE tablename = 'users'
  AND indexname = 'idx_users_first_meeting_reminder';
```

**완료 체크리스트:**
- [x] SQL 실행 완료 ✅ 2026-02-04
- [x] 2개 컬럼 추가 확인 ✅
- [x] 1개 인덱스 생성 확인 ✅

---

### 3. Vercel Cron 설정 ✅ 완료

**설정 위치:** `jidokhae/vercel.json`

**추가할 Cron 설정:**

```json
{
  "crons": [
    {
      "path": "/api/cron/onboarding-signup",
      "schedule": "0 1 * * *"
    },
    {
      "path": "/api/cron/onboarding-first-meeting",
      "schedule": "0 1 * * *"
    }
  ]
}
```

> **참고:** `0 1 * * *`는 UTC 기준 01:00 (한국시간 10:00)

**기존 Cron과 통합된 전체 설정 예시:**

```json
{
  "crons": [
    {
      "path": "/api/cron/reminder",
      "schedule": "0 13 * * *"
    },
    {
      "path": "/api/cron/waitlist",
      "schedule": "0 * * * *"
    },
    {
      "path": "/api/cron/auto-complete",
      "schedule": "0 18 * * *"
    },
    {
      "path": "/api/cron/afterglow",
      "schedule": "0,30 * * * *"
    },
    {
      "path": "/api/cron/onboarding-signup",
      "schedule": "0 1 * * *"
    },
    {
      "path": "/api/cron/onboarding-first-meeting",
      "schedule": "0 1 * * *"
    }
  ]
}
```

**완료 체크리스트:**
- [x] vercel.json에 Cron 설정 추가 ✅ 2026-02-04
- [ ] Vercel 배포 후 Cron 등록 확인 (Vercel Dashboard > Crons) - 배포 후 확인
- [x] CRON_SECRET 환경변수 설정 확인 ✅

---

### M6-Onboarding 준비 작업 체크리스트

### 완료된 작업 ✅

| # | 작업 | Phase | 담당 | 완료일 |
|:-:|------|:-----:|:----:|:------:|
| 1 | DB 마이그레이션 (Phase 1) | Phase 1 | 운영자 | 2026-02-04 |
| 2 | DB 마이그레이션 (Phase 4 & 5) | Phase 4~5 | 운영자 | 2026-02-04 |
| 3 | Vercel Cron 설정 | Phase 4 | 개발자 | 2026-02-04 |

### 남은 작업 (배포 후 진행)

| # | 작업 | Phase | 담당 | 우선순위 |
|:-:|------|:-----:|:----:|:--------:|
| 1 | SIGNUP_WELCOME 템플릿 등록 | Phase 4 | 운영자 | 높음 |
| 2 | SIGNUP_REMINDER_DAY3 템플릿 등록 | Phase 4 | 운영자 | 높음 |
| 3 | SIGNUP_REMINDER_DAY7 템플릿 등록 | Phase 4 | 운영자 | 중간 |
| 4 | FIRST_MEETING_DAY3 템플릿 등록 | Phase 5 | 운영자 | 중간 |
| 5 | FIRST_MEETING_DAY7 템플릿 등록 | Phase 5 | 운영자 | 중간 |
| 6 | 템플릿 ID 코드에 반영 | Phase 4 | 개발자 | 승인 후 |

---

## 솔라피 알림톡 템플릿 등록

### 카카오 알림톡 심사 기준 안내

> **중요:** 카카오 알림톡은 **정보성 메시지만** 허용됩니다. 광고성/마케팅 목적의 메시지는 반려됩니다.

#### 승인 가능한 메시지 (정보성)

- 결제/입금 관련 안내 (기한, 상태 변경)
- 예약/신청 상태 변경 알림
- 일정 리마인드 (확정된 예약 건)
- 자격/상태 변경 고지

#### 반려 가능성 높은 메시지 (광고성)

- 참여 독려/유도 메시지
- "함께 해요", "기다리고 있어요" 등 마케팅 문구
- 첫 참여 유도, 재참여 유도
- 미신청자 대상 권유 메시지

### 미등록 템플릿 (우선순위 순)

| # | 템플릿 코드 | 용도 | 우선순위 | 반려 위험 | 상태 |
|:-:|-------------|------|:--------:|:--------:|:----:|
| 1 | `TRANSFER_DEADLINE_WARNING` | 입금 기한 임박 (6시간 전) | **높음** | 낮음 | [ ] |
| 2 | `WAITLIST_EXPIRED` | 대기 응답 기한 만료 | **높음** | 낮음 | [ ] |
| 3 | `REMINDER_3D` | 모임 3일 전 리마인드 | 중간 | 낮음 | [ ] |
| 4 | `ELIGIBILITY_WARNING` | 자격 만료 임박 (6개월 룰) | 낮음 | 낮음 | [ ] |
| 5 | `MONTHLY_ENCOURAGE` | 월말 참여 독려 | 낮음 | **높음** | [ ] |
| 6 | `DORMANT_RISK` | 휴면 위험 알림 | 낮음 | **높음** | [ ] |
| 7 | `ONBOARDING_RISK` | 온보딩 이탈 위험 | 낮음 | **높음** | [ ] |
| 8 | `ADMIN_NOTICE` | 관리자 수동 공지 | 낮음 | **높음** | [ ] |
| 9 | `PRAISE_NUDGE` | 칭찬 보내기 유도 | **높음** | 낮음 | [ ] |

> **참고:** 1~2번, 9번은 현재 Cron이 실행 중이나 템플릿이 없어 발송 실패합니다.
> **경고:** 5~8번은 마케팅 성격이 강하거나 변수만으로 구성되어 반려될 가능성이 높습니다.

### 등록 시 참고할 템플릿 문구 (강조표기형)

> **형식 안내:** 강조표기형은 상단에 강조 제목(50자 이내)이 표시되고, 그 아래 본문이 이어집니다.

---

#### 입금 기한 임박 (`TRANSFER_DEADLINE_WARNING`) - 반려 위험: 낮음

**강조 제목:** `입금 기한 안내`

**본문:**
```
#{이름}님, #{모임명} 참가비 입금 기한이 6시간 남았습니다.

기한: #{기한}까지

기한 내 입금이 확인되지 않으면 신청이 자동 취소됩니다.
```

**버튼:** 입금 정보 확인 → `https://jidokhae.com/mypage`

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{모임명}` | 모임 제목 | 데미안 |
| `#{기한}` | 입금 기한 | 2026년 2월 12일 오후 3시 |

---

#### 대기 응답 기한 만료 (`WAITLIST_EXPIRED`) - 반려 위험: 낮음

> **주의:** 현재 `waitlist-notification.ts`의 `processExpiredWaitlists()`는 상태만 변경하고 알림을 발송하지 않습니다.
> 템플릿 등록 후 발송 코드 추가가 필요합니다.

**강조 제목:** `대기 순번 만료 안내`

**본문:**
```
#{이름}님, #{모임명} 대기 응답 기한이 만료되어 대기 순번이 취소되었습니다.

다음에 자리가 발생하면 다시 알림을 받으시려면 대기 신청을 다시 해주세요.
```

**버튼:** 모임 확인 → `https://jidokhae.com`

**변수 목록:**
| 변수명 | 설명 | 예시 텍스트 (심사용) |
|--------|------|---------------------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{모임명}` | 모임 제목 | 데미안 |

---

#### 3일 전 리마인드 (`REMINDER_3D`) - 반려 위험: 낮음

**강조 제목:** `모임 일정 안내`

**본문:**
```
#{이름}님, 신청하신 #{모임명} 모임이 3일 후 진행됩니다.

일시: #{일시}
장소: #{장소}

참석이 어려우시면 취소 후 다른 분께 자리를 양보해주세요.
```

**버튼:** 상세 정보 확인 → `https://jidokhae.com/mypage`

> **코드 수정 필요:** `reminder.ts` - 현재 `날짜`, `시간`을 별도 전송. `일시`로 통합하여 전송하도록 변경 필요.

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{모임명}` | 모임 제목 | 데미안 |
| `#{일시}` | 모임 일시 | 2월 15일 토요일 오후 2시 |
| `#{장소}` | 모임 장소 | 경주 황리단길 카페 |

---

#### 자격 만료 임박 (`ELIGIBILITY_WARNING`) - 반려 위험: 낮음

**강조 제목:** `정기모임 참여 자격 안내`

**본문:**
```
#{이름}님, 정기모임 참여 자격 만료 예정을 안내드립니다.

마지막 참여일: #{마지막참여일}
자격 만료 예정일: #{만료예정일}

정기모임은 6개월 내 1회 이상 참여 시 자격이 유지됩니다.
```

**버튼:** 모임 일정 확인 → `https://jidokhae.com`

> **코드 수정 필요:** `segment-notification.ts` - 현재 `이름`만 전송. `마지막참여일`, `만료예정일` 변수 추가 필요.

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{마지막참여일}` | 마지막 참여 일자 | 2025년 8월 15일 |
| `#{만료예정일}` | 자격 만료 예정일 | 2026년 2월 15일 |

---

#### 월말 참여 독려 (`MONTHLY_ENCOURAGE`) - 반려 위험: 높음

> **경고:** 마케팅/광고성 메시지로 분류되어 반려될 가능성이 높습니다.
> **대안:** 친구톡(광고성 메시지) 또는 문자(SMS/LMS)로 발송 검토

**강조 제목:** `이번 달 모임 안내`

**본문:**
```
#{이름}님, 이번 달 남은 모임 일정을 안내드립니다.

이번 달 참여하지 않으신 경우 아래에서 일정을 확인하실 수 있습니다.
```

**버튼:** 모임 일정 보기 → `https://jidokhae.com`

**변수 목록:**
| 변수명 | 설명 | 예시 텍스트 (심사용) |
|--------|------|---------------------|
| `#{이름}` | 회원 이름 | 김지독 |

---

#### 휴면 위험 (`DORMANT_RISK`) - 반려 위험: 높음

> **경고:** 재참여 유도 메시지로 반려될 가능성이 높습니다.
> **대안:** 친구톡(광고성 메시지) 또는 문자(SMS/LMS)로 발송 검토

**강조 제목:** `회원 활동 안내`

**본문:**
```
#{이름}님, 마지막 모임 참여 후 #{경과일}일이 경과했습니다.

활동 내역과 다음 모임 일정을 확인하실 수 있습니다.
```

**버튼:** 내 활동 확인 → `https://jidokhae.com/mypage`

> **코드 수정 필요:** `segment-notification.ts` - 현재 `이름`만 전송. `경과일` 변수 추가 필요.

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{경과일}` | 마지막 참여 후 경과 일수 | 45 |

---

#### 온보딩 이탈 위험 (`ONBOARDING_RISK`) - 반려 위험: 높음

> **경고:** 첫 참여 유도 메시지로 반려될 가능성이 높습니다.
> **대안:** 친구톡(광고성 메시지) 또는 문자(SMS/LMS)로 발송 검토

**강조 제목:** `가입 후 활동 안내`

**본문:**
```
#{이름}님, 가입 후 #{경과일}일이 경과했습니다.

첫 모임 참여 방법과 진행 중인 모임 일정을 확인하실 수 있습니다.
```

**버튼:** 모임 확인 → `https://jidokhae.com`

> **코드 수정 필요:** `segment-notification.ts` - 현재 `이름`만 전송. `경과일` 변수 추가 필요.

**변수 목록:**
| 변수명 | 설명 | 예시 |
|--------|------|------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{경과일}` | 가입 후 경과 일수 | 14 |

---

#### 관리자 공지 (`ADMIN_NOTICE`) - 반려 위험: 높음

> **경고:** 본문이 변수만으로 구성된 템플릿은 **카카오 심사에서 반려**됩니다.
> 가이드라인: "변수만으로 이루어진 템플릿은 등록 불가"
>
> **권장:** 고정 문구 + 변수 조합으로 재설계 필요

**강조 제목:** `낮과 밤의 서재 공지사항`

**본문:**
```
#{이름}님께 안내드립니다.

#{메시지}

자세한 내용은 아래 버튼을 눌러 확인해주세요.
```

**버튼:** 자세히 보기 → `https://jidokhae.com`

**변수 목록:**
| 변수명 | 설명 | 예시 텍스트 (심사용) |
|--------|------|---------------------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{메시지}` | 관리자가 입력한 공지 내용 | 2월 15일 경주 모임 장소가 변경되었습니다. |

---

#### 칭찬 보내기 유도 (`PRAISE_NUDGE`) - 반려 위험: 낮음

> **분류:** 정보성 메시지 (모임 참여 완료 후 칭찬 기능 안내)

**강조 제목:** `모임 참여 완료 안내`

**본문:**
```
#{이름}님, #{모임명} 모임 참여가 완료되었습니다.

함께한 멤버에게 칭찬을 보낼 수 있습니다.
칭찬을 보내면 상대방에게 알림이 전달됩니다.

마이페이지에서 칭찬 보내기를 이용하실 수 있습니다.
```

**버튼:** 칭찬 보내기 → `https://jidokhae.com/mypage`

**카테고리:** 회원/가입/인증

> **코드 수정 필요:** `praise-nudge/route.ts` - 현재 `이름`만 전송. `모임명` 변수 추가 필요.

**변수 목록:**
| 변수명 | 설명 | 예시 텍스트 (심사용) |
|--------|------|---------------------|
| `#{이름}` | 회원 이름 | 김지독 |
| `#{모임명}` | 참여 완료한 모임 제목 | 데미안 |

### 등록된 템플릿 ID

| 알림 유형 | 솔라피 템플릿 ID |
|----------|------------------|
| 내일 리마인드 | `KA01TP26013110144750559PJ8DRKmUe` |
| 당일 리마인드 | `KA01TP260131101632094bQBmdj7DTgk` |
| 빈자리 알림 | `KA01TP260131101846595Ia3f022Toxv` |
| 신청 접수 완료 | `KA01TP260131104954973tJPe3gXEmE6` |
| 취소/환불 접수 | `KA01TP260131102910054EeKya0x7uJT` |
| 입금 확인 완료 | `KA01TP260131102614264JqtfvpsSALc` |
| 신청 취소 (기한만료) | `KA01TP2601311027124798sVSTMzzQab` |
| 환영합니다 | `KA01TP260131102303488fxzX3GpPBFN` |
| 모임 후기 요청 | `KA01PF260120113206182sLWZ2NcEsUJ` |

---

## Supabase 설정

| 작업 | 설명 | 상태 |
|------|------|------|
| gallery_images 테이블 생성 | Admin 갤러리 기능용 | 확인 필요 |
| RLS 정책 적용 | 각 테이블 보안 정책 | 확인 필요 |

---

## 문서 관리

| 작업 | 설명 | 상태 |
|------|------|------|
| core/ 문서 버전 업데이트 | 서비스 개요 v1.5, PRD v1.6, 기술스택 v1.4, 시스템구조 v1.6 | 완료 |
| 참고자료 폴더 정리 | 델타 문서 정리 (선택) | 보류 |

---

## 기타

| 작업 | 설명 | 상태 |
|------|------|------|
| 이모지 제거 | 솔라피 템플릿 4개에서 이모지 제거 (취소/환불, 신청취소, 입금확인, 당일리마인드) | 완료 필요 |

---

## 결제 테스트 방법

Beta 출시 전 결제 기능이 정상 동작하는지 확인하는 테스트 가이드입니다.

### 사전 준비

1. **포트원 테스트 모드 확인**
   - [포트원 관리자](https://admin.portone.io) 접속
   - 우측 상단 **테스트/실거래** 토글이 **테스트**로 설정되어 있는지 확인
   - 테스트 모드에서는 실제 결제가 발생하지 않습니다

2. **환경 변수 확인**
   ```
   # .env.local 파일에서 확인
   NEXT_PUBLIC_PORTONE_STORE_ID=store-xxxxx  # V2 형식 (store-로 시작)
   PORTONE_API_SECRET=PortOneSecret-xxxxx
   ```

3. **개발 서버 실행**
   ```bash
   cd jidokhae
   npm run dev
   ```

---

### 테스트 1: 카카오페이 결제

| 단계 | 동작 | 예상 결과 |
|:----:|------|----------|
| 1 | 로그인 후 홈 화면에서 **모임 선택** | 모임 상세 Bottom Sheet 열림 |
| 2 | **"함께 읽기"** 버튼 클릭 | 결제 방식 선택 화면 |
| 3 | **카카오페이** 선택 | 카카오페이 결제창 열림 |
| 4 | 테스트 결제 진행 | 결제 완료 (실제 결제 안 됨) |
| 5 | **마이페이지** 확인 | 신청 내역에 **"참가 확정"** 상태 표시 |

> **참고:** PC에서는 QR 코드 스캔이 필요할 수 있습니다. 모바일에서 테스트하면 더 원활합니다.

---

### 테스트 2: 계좌이체 결제

| 단계 | 동작 | 예상 결과 |
|:----:|------|----------|
| 1 | 모임 선택 > **"함께 읽기"** 클릭 | 결제 방식 선택 화면 |
| 2 | **계좌이체** 선택 | 계좌 정보 표시 |
| 3 | 계좌번호 **클립보드 복사** 버튼 클릭 | 복사 완료 토스트 |
| 4 | **"입금했습니다"** 체크박스 선택 | 버튼 활성화 |
| 5 | **확인** 버튼 클릭 | 신청 완료, **"입금대기"** 상태 |
| 6 | **Admin 페이지** (`/admin`) 접속 | 입금대기 목록에 표시 |
| 7 | 해당 신청 건의 **"입금 확인"** 버튼 클릭 | **"참가 확정"** 으로 전환 |

> **24시간 미입금 자동 취소:** 테스트 환경에서는 수동으로 확인해야 합니다.

---

### 테스트 3: 환불 (취소)

| 단계 | 동작 | 예상 결과 |
|:----:|------|----------|
| 1 | **마이페이지** > 확정된 신청 선택 | 신청 상세 화면 |
| 2 | **"다음 기회에"** 버튼 클릭 | 취소 확인 Bottom Sheet |
| 3 | **마음 돌리기 화면** 확인 | "아쉬워요..." 문구 표시 |
| 4 | **취소 사유** 선택 | 사유 선택 완료 |
| 5 | **취소 확인** 버튼 클릭 | 취소 완료 |
| 6 | **환불 규정** 확인 | 모임 유형별 환불 금액 정확히 계산됨 |

**환불 규정 (참고):**
- 정기모임: 3일 전 100%, 2일 전 50%, 이후 불가
- 토론모임: 2주 전 100%, 7일 전 50%, 이후 불가

---

### 테스트 4: 대기 신청

| 단계 | 동작 | 예상 결과 |
|:----:|------|----------|
| 1 | **마감된 모임** 선택 | "마감" 뱃지 표시 |
| 2 | **"대기 신청"** 버튼 클릭 | 대기 등록 (결제 없음) |
| 3 | **마이페이지** 확인 | 대기 내역에 순번 표시 |

---

### 문제 발생 시 체크리스트

| 증상 | 확인 사항 | 해결 방법 |
|------|----------|----------|
| "Store ID is not recognized" | V1 테스트 코드 사용 여부 | 포트원 관리자에서 V2 Store ID 확인 |
| 결제창이 안 열림 | 포트원 SDK 로드 확인 | 브라우저 콘솔에서 에러 확인 |
| 결제 완료 후 상태 미반영 | 웹훅 처리 확인 | 서버 로그 확인 |
| 환불 금액 오류 | 환불 규정 데이터 확인 | DB의 `refund_policies` 테이블 확인 |

---

### 테스트 계정 (권장)

테스트용 계정을 미리 생성해두면 편리합니다:

| 역할 | 이메일 | 용도 |
|------|--------|------|
| Super Admin | super@test.com | 전체 권한 테스트 |
| Admin | admin@test.com | 운영자 기능 테스트 |
| Member | member@test.com | 일반 회원 플로우 테스트 |

---

## 카카오 비즈니스 채널 설정

| 작업 | 상태 |
|------|------|
| 카카오 비즈니스 채널 승인 | 완료 |
| 솔라피 채널 연동 | 확인 필요 |

---

## 개발 대기 중인 항목

> 아래 항목들은 솔라피에 템플릿이 등록되어 있으나, 코드에서 발송 로직이 누락된 상태입니다.
> 개발자에게 요청이 필요합니다.

| 템플릿 | 솔라피 ID | 상황 | 필요 작업 |
|--------|-----------|------|-----------|
| 신청 접수 완료 | `KA01TP260131104954973...` | 결제 완료 시 미발송 | 웹훅에서 발송 코드 추가 |
| 취소/환불 접수 | `KA01TP260131102910054...` | 취소 시 미발송 | 취소 API에서 발송 코드 추가 |

---

## 작업 현황 요약

### 즉시 처리 필요 (Cron 실행 중이나 템플릿 없음)

| 템플릿 | Cron | 영향 |
|--------|------|------|
| `TRANSFER_DEADLINE_WARNING` | `/api/cron/transfer-timeout` (매시간) | 입금 기한 6시간 전 알림 미발송 |
| `PRAISE_NUDGE` | `/api/cron/praise-nudge` (매일) | 모임 후 칭찬 유도 알림 미발송 |

---

## 친구톡 전환 준비 (광고성 메시지용)

> 알림톡에서 반려될 가능성이 높은 마케팅 메시지는 **친구톡**으로 발송해야 합니다.

### 친구톡 vs 알림톡 비교

| 항목 | 알림톡 | 친구톡 |
|------|--------|--------|
| 메시지 성격 | 정보성만 | 광고성 허용 |
| 수신 동의 | 불필요 | **필수** (채널 친구 추가) |
| 발송 대상 | 전화번호만 있으면 발송 | 채널 친구만 발송 |
| 비용 | ~15원/건 | ~20원/건 |
| 심사 | 엄격 | 상대적으로 유연 |

### 채널 친구 추가 유도 알림톡 (`CHANNEL_FRIEND_INVITE`)

> 친구톡 발송을 위해 먼저 채널 친구 추가를 유도하는 **알림톡** 필요
> **메시지 유형:** **채널추가형** (강조표기형이 아님)
> 카카오에서 자동으로 채널 추가 버튼 + 동의 문구를 생성합니다.

**본문:**
```
#{이름}님, 낮과 밤의 서재 알림 설정을 안내드립니다.

카카오톡 채널을 추가하시면 서비스 관련 소식을 받으실 수 있습니다.
```

> **채널추가형 자동 삽입 문구** (수정 불가):
> "채널 추가하고 이 채널의 마케팅 메시지 등을 카카오톡으로 받기"

**버튼:** 채널 친구 추가 → `https://pf.kakao.com/[채널ID]`

**카테고리:** 회원/가입/인증

**반려 위험:** 낮음 (수신 동의 안내는 정보성)

**변수 목록:**
| 변수명 | 설명 | 예시 텍스트 (심사용) |
|--------|------|---------------------|
| `#{이름}` | 회원 이름 | 김지독 |

### 친구톡 전환 준비 작업

| 단계 | 작업 | 담당 | 상태 |
|:----:|------|:----:|:----:|
| 1 | 카카오톡 채널 URL 확인 | 운영자 | [ ] |
| 2 | `CHANNEL_FRIEND_INVITE` 알림톡 등록 | 운영자 | [ ] |
| 3 | DB에 `marketing_consent` 컬럼 추가 | 개발자 | [ ] |
| 4 | 가입 시 알림톡 자동 발송 로직 추가 | 개발자 | [ ] |
| 5 | 친구톡 템플릿 등록 (광고성) | 운영자 | [ ] |

---

### 향후 처리

| 템플릿 | 영향 범위 |
|--------|-----------|
| `REMINDER_3D` | 3일 전 리마인드 미발송 (현재 1일전/당일만 발송) |
| `WAITLIST_EXPIRED` | 대기 만료 알림 미발송 |
| 세그먼트 알림 4종 | 월말/휴면/이탈 독려 미발송 |
| 온보딩 템플릿 5종 | 가입/첫모임 후 리마인드 미발송 |

---

## 개발자 코드 수정 필요 항목 (템플릿 변수 불일치)

> **교차 검증 결과 (2026-02-11):** 아래 코드들은 템플릿 명세에서 요구하는 변수를 전송하지 않습니다.
> 템플릿 등록 전 코드 수정이 선행되어야 합니다.

| # | 템플릿 | 코드 파일 | 누락 변수 | 우선순위 |
|:-:|--------|-----------|-----------|:--------:|
| 1 | `PRAISE_NUDGE` | `api/cron/praise-nudge/route.ts` | `모임명` | **높음** |
| 2 | `REMINDER_3D` | `lib/reminder.ts` | `일시` (현재 `날짜`+`시간` 분리 전송) | 중간 |
| 3 | `ELIGIBILITY_WARNING` | `lib/segment-notification.ts` | `마지막참여일`, `만료예정일` | 낮음 |
| 4 | `DORMANT_RISK` | `lib/segment-notification.ts` | `경과일` | 낮음 |
| 5 | `ONBOARDING_RISK` | `lib/segment-notification.ts` | `경과일` | 낮음 |
| 6 | `FIRST_MEETING_DAY7` | `api/cron/onboarding-first-meeting/route.ts` | `지역`, `남은자리` | 낮음 |
| 7 | `WAITLIST_EXPIRED` | `lib/waitlist-notification.ts` | **(발송 코드 자체 없음)** | 높음 |

### 상세 수정 가이드

#### 1. `PRAISE_NUDGE` - 모임명 추가
- **파일:** `src/app/api/cron/praise-nudge/route.ts` (91행)
- **현재:** `variables: { 이름: user.name }`
- **수정:** 완료된 모임 정보를 조인하여 `모임명` 변수 추가

#### 2. `REMINDER_3D` - 일시 변수 추가
- **파일:** `src/lib/reminder.ts` (266~274행)
- **현재:** `날짜: formatMeetingDate(...)`, `시간: formatMeetingTime(...)` (별도 전송)
- **주의:** `sendReminder()`는 REMINDER_1D, REMINDER_TODAY와 **공유** 함수. 등록된 템플릿이 `날짜`/`시간`을 사용하므로 기존 변수는 유지해야 함.
- **수정:** 기존 `날짜`, `시간` 유지 + `일시: formatMeetingDate(...) + ' ' + formatMeetingTime(...)` 추가

#### 3. `ELIGIBILITY_WARNING` - 참여일/만료일 추가
- **파일:** `src/lib/segment-notification.ts` (253행)
- **현재:** `variables: { 이름: target.userName }`
- **수정:** `getEligibilityWarningTargets()`에서 `마지막참여일`, `만료예정일` 반환하도록 확장

#### 4. `DORMANT_RISK` - 경과일 추가
- **파일:** `src/lib/segment-notification.ts` (284행)
- **현재:** `variables: { 이름: target.userName }`
- **수정:** `getDormantRiskTargets()`에서 `경과일` 계산하여 반환

#### 5. `ONBOARDING_RISK` - 경과일 추가
- **파일:** `src/lib/segment-notification.ts` (314행)
- **현재:** `variables: { 이름: target.userName }`
- **수정:** `getOnboardingRiskTargets()`에서 가입 후 경과일 계산하여 반환

#### 6. `FIRST_MEETING_DAY7` - 지역/남은자리 추가
- **파일:** `src/app/api/cron/onboarding-first-meeting/route.ts` (54행)
- **현재:** `이름`, `모임명`, `다음모임일시`, `신청인원`, `책제목`
- **수정:** 모임에서 `지역` 조회, `남은자리 = max_capacity - current` 계산 추가

#### 7. `WAITLIST_EXPIRED` - 발송 코드 신규 작성
- **파일:** `src/lib/waitlist-notification.ts` (`processExpiredWaitlists` 함수)
- **현재:** 상태만 `expired`로 변경, 만료 대상자에게 알림 미발송
- **수정:** 상태 변경 후 `sendAndLogNotification(WAITLIST_EXPIRED, { 이름, 모임명 })` 추가

---

*최종 업데이트: 2026-02-11 (코드-템플릿 교차 검증, 문서 복원 + 코드 수정 항목 정리)*